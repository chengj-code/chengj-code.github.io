<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="chengj-code">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2025/05/17/vue2源码学习/vue2源码学习 - vue 实例初始化（核心入口）/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue2源码学习 - Vue 实例初始化（核心入口）">
<meta property="og:url" content="http://example.com/2025/05/17/Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%20-%20Vue%20%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%88%E6%A0%B8%E5%BF%83%E5%85%A5%E5%8F%A3%EF%BC%89/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/redefine-og.webp">
<meta property="article:published_time" content="2025-05-16T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-07T14:14:50.988Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="源码解读, v2.7.16">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/redefine-og.webp">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/chengj-favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/chengj-favicon.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/chengj-favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            Vue2源码学习 - Vue 实例初始化（核心入口） | chengj-code的博客
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":6,"number":true,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":{"enable":true,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/thumbnail01.jpg","dark":"/images/thumbnail02.jpg"},"title":"认准的路，别问多远，坚持走下去","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"11.4.1"}},"version":"2.8.2","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>



<body>
	<div class="progress-bar-container">
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                chengj-code的博客
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">1</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">7</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			
			
			<img src="/images/default-thumbnail.jpg" alt="Vue2源码学习 - Vue 实例初始化（核心入口）" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75" />
			
			<div class="w-full flex items-center absolute bottom-0 justify-start">
				<h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-semibold backdrop-blur-lg rounded-xl border border-border-color ">Vue2源码学习 - Vue 实例初始化（核心入口）</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/chengj-avatar.jpeg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">chengj-code</span>
					
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv1</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-05-17</span>
        <span class="mobile">2025-05-17</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-06-07 22:14:50</span>
            <span class="mobile">2025-06-07 22:14:50</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-v2-7-16/">源码解读, v2.7.16</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="Vue2源码解读顺序"><a href="#Vue2源码解读顺序" class="headerlink" title="Vue2源码解读顺序"></a>Vue2源码解读顺序</h1><ol>
<li>从入口开始：先理解 <code>new Vue()</code> 的实例化过程，掌握生命周期和初始化流程。</li>
<li>深入响应式：研究 <code>Observer</code>、<code>Dep</code>、<code>Watcher</code> 的协作机制，理解数据绑定原理。</li>
<li>模板编译：分析模板如何转换为 <code>render</code> 函数，了解 AST 优化策略。</li>
<li>虚拟 DOM：学习 VNode 结构与 Diff 算法，掌握高效 DOM 更新的实现。</li>
<li>扩展功能：最后阅读组件系统、插件机制等高级特性，完善对框架整体的理解。</li>
</ol>
<h1 id="Vue-实例初始化（核心入口）"><a href="#Vue-实例初始化（核心入口）" class="headerlink" title="Vue 实例初始化（核心入口）"></a>Vue 实例初始化（核心入口）</h1><ul>
<li><strong>关键文件</strong>：<code>src/core/instance/index.js</code>、<code>src/core/instance/init.js</code></li>
<li><strong>核心逻辑</strong>：<ul>
<li><strong>构造函数</strong>：通过 <code>new Vue()</code> 创建实例时，调用 <code>this._init(options)</code> 初始化配置项，合并选项（如 <code>data</code>、<code>methods</code>、生命周期钩子等）。</li>
<li><strong>Mixin 扩展</strong>：通过 <code>initMixin</code>、<code>stateMixin</code> 等函数在原型链上挂载 <code>$data</code>、<code>$watch</code>、<code>$set</code> 等实例方法。</li>
<li><strong>生命周期初始化</strong>：依次调用 <code>initLifecycle</code>、<code>initEvents</code>、<code>initRender</code> 等函数，触发 <code>beforeCreate</code> 和 <code>created</code> 钩子。</li>
</ul>
</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过多个 Mixin 函数向 Vue 原型挂载核心方法</span></span><br><span class="line"><span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)       <span class="comment">// 注入 _init 方法</span></span><br><span class="line"><span class="title function_">stateMixin</span>(<span class="title class_">Vue</span>)      <span class="comment">// 注入 $data/$props/$set/$delete/$watch</span></span><br><span class="line"><span class="title function_">eventsMixin</span>(<span class="title class_">Vue</span>)     <span class="comment">// 注入 $on/$once/$off/$emit</span></span><br><span class="line"><span class="title function_">lifecycleMixin</span>(<span class="title class_">Vue</span>)  <span class="comment">// 注入 _update/$forceUpdate/$destroy</span></span><br><span class="line"><span class="title function_">renderMixin</span>(<span class="title class_">Vue</span>)     <span class="comment">// 注入 $nextTick/_render 等</span></span><br></pre></td></tr></table></figure></div>

<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><h3 id="initMixin"><a href="#initMixin" class="headerlink" title="initMixin"></a>initMixin</h3><p><strong>关键文件</strong>：<code>src/core/instance/index.js</code>、<code>src/core/instance/init.js</code></p>
<p>在<code>initMixin</code>方法中给Vue实例上挂载了<code>_init</code>方法，通过 <code>new Vue()</code> 创建实例时，调用 <code>this._init(options)</code> 初始化配置项。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span>(<span class="params"><span class="title class_">Vue</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">options</span>?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    vm.<span class="property">_uid</span> = uid++ <span class="comment">// 为每个 Vue 实例分配唯一的递增 ID (_uid)，用于调试或追踪实例。</span></span><br><span class="line">    <span class="keyword">let</span> startTag, endTag</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">      endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">      <span class="title function_">mark</span>(startTag)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 作用：在开发环境下，若启用了性能监控（config.performance），则使用 mark 记录实例初始化的起始时间点。</span></span><br><span class="line">    vm.<span class="property">_isVue</span> = <span class="literal">true</span> <span class="comment">// 作用：标记当前对象为 Vue 实例，避免被响应式系统观测（例如在 data 中返回 Vue 实例时跳过劫持）。</span></span><br><span class="line">    vm.<span class="property">__v_skip</span> = <span class="literal">true</span> <span class="comment">// 作用：显式声明该对象跳过响应式处理（Vue 内部优化逻辑）。</span></span><br><span class="line">    vm.<span class="property">_scope</span> = <span class="keyword">new</span> <span class="title class_">EffectScope</span>(<span class="literal">true</span> <span class="comment">/* detached */</span>)</span><br><span class="line">    vm.<span class="property">_scope</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    vm.<span class="property">_scope</span>.<span class="property">_vm</span> = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 作用：创建一个独立的副作用作用域 (EffectScope)，用于管理该实例的响应式副作用（如 watch、computed）。</span></span><br><span class="line">         <span class="comment">// detached: true 表示该作用域不继承父级作用域。</span></span><br><span class="line">         <span class="comment">// _vm = true 标记该作用域与 Vue 实例关联。</span></span><br><span class="line">    <span class="comment">// merge options</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">_isComponent</span>) &#123;</span><br><span class="line">      <span class="title function_">initInternalComponent</span>(vm, options <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">$options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">        <span class="title function_">resolveConstructorOptions</span>(vm.<span class="property">constructor</span> <span class="keyword">as</span> <span class="built_in">any</span>),</span><br><span class="line">        options || &#123;&#125;,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 作用：合并构造函数选项（如全局混入的选项）和实例化时传入的选项。</span></span><br><span class="line">    <span class="comment">// 内部组件优化：若为内部组件（如通过 &lt;component&gt; 创建的组件），直接快速合并选项（initInternalComponent）。</span></span><br><span class="line">    <span class="comment">// 普通组件：通过 mergeOptions 递归合并构造函数的默认选项（resolveConstructorOptions）和用户传入的 options。</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">initProxy</span>(vm)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 作用：在开发环境下，通过initProxy设置实例的渲染代理（拦截模板中未定义的属性访问并警告）；生产环境直接使用实例自身作为代理。</span></span><br><span class="line">    vm.<span class="property">_self</span> = vm <span class="comment">// 作用：保留实例自身的原始引用，避免代理后的对象干扰内部逻辑。</span></span><br><span class="line">    <span class="title function_">initLifecycle</span>(vm) <span class="comment">// 初始化实例的父子组件关系、$parent、$children 等属性。</span></span><br><span class="line">    <span class="title function_">initEvents</span>(vm) <span class="comment">// 初始化自定义事件监听（如 $on, $emit）。</span></span><br><span class="line">    <span class="title function_">initRender</span>(vm) <span class="comment">// 初始化插槽 ($slots)、$createElement 渲染函数等。</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeCreate&#x27;</span>, <span class="literal">undefined</span>, <span class="literal">false</span> <span class="comment">/* setContext */</span>) <span class="comment">// 触发 beforeCreate 生命周期钩子，此时数据观测 (data)、事件等尚未初始化。</span></span><br><span class="line">    <span class="title function_">initInjections</span>(vm) <span class="comment">// 在数据/属性初始化前解析父级提供的依赖注入 (inject)。</span></span><br><span class="line">    <span class="title function_">initState</span>(vm) <span class="comment">// 按顺序初始化 props → methods → data → computed → watch，建立响应式系统。</span></span><br><span class="line">    <span class="title function_">initProvide</span>(vm) <span class="comment">// 在数据/属性初始化后提供值给子组件 (provide)</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;created&#x27;</span>) <span class="comment">// 作用：触发 created 生命周期钩子，此时数据观测已完成，但 DOM 尚未挂载。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">      vm.<span class="property">_name</span> = <span class="title function_">formatComponentName</span>(vm, <span class="literal">false</span>)</span><br><span class="line">      <span class="title function_">mark</span>(endTag)</span><br><span class="line">      <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;vm._name&#125;</span> init`</span>, startTag, endTag)</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 作用：在开发环境下，记录实例初始化的耗时，并通过 measure 输出性能数据。</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">      vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 作用：如果选项中有 el 属性，则自动调用 $mount 方法挂载实例到 DOM。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initInternalComponent"><a href="#initInternalComponent" class="headerlink" title="initInternalComponent"></a>initInternalComponent</h4><ul>
<li><p><strong>避免深拷贝</strong>：动态组件的创建频繁且需要高效处理。通过原型继承，子组件可以直接复用父组件的配置选项（如生命周期钩子、方法等），避免了深拷贝父组件选项的开销。</p>
</li>
<li><p><strong>共享不可变属性</strong>：原型链上的方法或静态配置（如 <code>methods</code> 中的函数）无需每个实例单独存储，减少了内存占用。</p>
</li>
<li><p><strong>原型链继承选项</strong>：Vue 在初始化组件时，会将子组件的 <code>options</code> 对象通过 <code>Object.create(parentOptions)</code> 设置为父选项的原型。这样，子组件能自动继承父组件的默认配置。</p>
</li>
<li><p><strong>按需覆盖</strong>：子组件只需定义需要覆盖的选项（如 <code>data</code>、<code>props</code>），未定义的选项通过原型链查找父组件的配置，简化了选项合并逻辑。</p>
</li>
<li><p><strong>复用响应式结构</strong>：Vue 的响应式系统（如观察者模式）依赖选项的结构。通过原型共享，可以复用已处理的响应式描述符，减少重复的 <code>Object.defineProperty</code> 调用。</p>
</li>
<li><p><strong>构造函数复用</strong>：Vue 组件本质上是基于 <code>Vue</code> 构造函数的扩展。通过 <code>initInternalComponent</code> 设置原型，确保子组件的实例继承 <code>Vue.prototype</code> 上的核心方法（如 <code>$emit</code>、<code>$watch</code>），保持行为一致性。</p>
</li>
</ul>
<p><strong>核心作用</strong>：优化内部组件（如动态组件 <code>&lt;component :is=&quot;...&quot;&gt;</code>）的初始化性能，通过原型继承和直接赋值跳过动态选项合并，快速构建 <code>vm.$options</code></p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initInternalComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">options</span>: <span class="title class_">InternalComponentOptions</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 基于构造函数的 options 创建原型链继承的对象，避免深拷贝</span></span><br><span class="line">  <span class="keyword">const</span> opts = (vm.<span class="property">$options</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>((vm.<span class="property">constructor</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">options</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直接从父级 VNode 和组件选项中快速赋值，避免动态枚举性能开销</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = options.<span class="property">_parentVnode</span>;</span><br><span class="line">  opts.<span class="property">parent</span> = options.<span class="property">parent</span>;          <span class="comment">// 父组件实例</span></span><br><span class="line">  opts.<span class="property">_parentVnode</span> = parentVnode;       <span class="comment">// 父级 VNode 节点</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从父 VNode 的组件选项中提取关键数据</span></span><br><span class="line">  <span class="keyword">const</span> vnodeComponentOptions = parentVnode.<span class="property">componentOptions</span>!;</span><br><span class="line">  opts.<span class="property">propsData</span> = vnodeComponentOptions.<span class="property">propsData</span>;      <span class="comment">// 父组件传递的 props 数据</span></span><br><span class="line">  opts.<span class="property">_parentListeners</span> = vnodeComponentOptions.<span class="property">listeners</span>; <span class="comment">// 父组件监听的事件</span></span><br><span class="line">  opts.<span class="property">_renderChildren</span> = vnodeComponentOptions.<span class="property">children</span>;   <span class="comment">// 子节点（插槽内容）</span></span><br><span class="line">  opts.<span class="property">_componentTag</span> = vnodeComponentOptions.<span class="property">tag</span>;         <span class="comment">// 组件标签名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果父级传递了自定义 render 函数，直接覆盖默认选项</span></span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">render</span>) &#123;</span><br><span class="line">    opts.<span class="property">render</span> = options.<span class="property">render</span>;                <span class="comment">// 自定义渲染函数</span></span><br><span class="line">    opts.<span class="property">staticRenderFns</span> = options.<span class="property">staticRenderFns</span>; <span class="comment">// 静态渲染函数（优化用）</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="resolveConstructorOptions"><a href="#resolveConstructorOptions" class="headerlink" title="resolveConstructorOptions"></a>resolveConstructorOptions</h4><ul>
<li><strong>动态更新父类选项</strong>：当父类选项被动态修改时，子类能感知并重新合并选项。</li>
<li><strong>处理子类自身修改</strong>：合并子类在 <code>extend</code> 后可能被手动修改的选项。</li>
<li><strong>保证选项一致性</strong>：确保组件实例的配置是最新且正确的，避免因缓存旧选项导致的意外行为。</li>
<li><strong>支持递归组件</strong>：自动注册组件名称，便于模板中的递归调用。</li>
</ul>
<p>当通过 <code>Vue.extend</code> 创建子类构造函数时，子类会继承父类的选项。但父类的选项可能在运行时被动态修改（例如通过 <code>Vue.mixin</code> 或直接修改全局配置）。此时，子类需要感知父类选项的变化并重新合并自己的选项，否则可能使用过时的配置。<code>resolveConstructorOptions</code> 会递归检查父类构造函数的选项，确保每一层父类的选项都是最新的。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveConstructorOptions</span>(<span class="params"><span class="title class_">Ctor</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> options = <span class="title class_">Ctor</span>.<span class="property">options</span>;</span><br><span class="line">  <span class="comment">// 递归处理父类（通过 Vue.extend 继承的父构造函数）</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Ctor</span>.<span class="property">super</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> superOptions = <span class="title function_">resolveConstructorOptions</span>(<span class="title class_">Ctor</span>.<span class="property">super</span>); <span class="comment">// 递归解析父类选项</span></span><br><span class="line">    <span class="keyword">const</span> cachedSuperOptions = <span class="title class_">Ctor</span>.<span class="property">superOptions</span>; <span class="comment">// 父类上一次缓存的选项</span></span><br><span class="line">    <span class="keyword">if</span> (superOptions !== cachedSuperOptions) &#123;</span><br><span class="line">      <span class="comment">// 父类选项发生变化（例如动态修改了全局配置）</span></span><br><span class="line">      <span class="title class_">Ctor</span>.<span class="property">superOptions</span> = superOptions; <span class="comment">// 更新缓存的父类选项</span></span><br><span class="line">      <span class="comment">// 检查子类是否有被动态修改的选项（例如混入后手动修改）</span></span><br><span class="line">      <span class="keyword">const</span> modifiedOptions = <span class="title function_">resolveModifiedOptions</span>(<span class="title class_">Ctor</span>);</span><br><span class="line">      <span class="comment">// 合并修改到 extendOptions（子类扩展时传入的选项）</span></span><br><span class="line">      <span class="keyword">if</span> (modifiedOptions) &#123;</span><br><span class="line">        <span class="title function_">extend</span>(<span class="title class_">Ctor</span>.<span class="property">extendOptions</span>, modifiedOptions);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 重新合并父类选项和子类扩展选项</span></span><br><span class="line">      options = <span class="title class_">Ctor</span>.<span class="property">options</span> = <span class="title function_">mergeOptions</span>(superOptions, <span class="title class_">Ctor</span>.<span class="property">extendOptions</span>);</span><br><span class="line">      <span class="comment">// 注册组件自身名称（便于递归调用）</span></span><br><span class="line">      <span class="keyword">if</span> (options.<span class="property">name</span>) &#123;</span><br><span class="line">        options.<span class="property">components</span>[options.<span class="property">name</span>] = <span class="title class_">Ctor</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options; <span class="comment">// 返回最终的构造函数选项</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="resolveModifiedOptions"><a href="#resolveModifiedOptions" class="headerlink" title="resolveModifiedOptions"></a>resolveModifiedOptions</h4><p><strong>核心作用</strong>：检测构造函数选项是否被动态修改（例如通过 <code>Vue.mixin</code> 后手动修改），确保在父类选项变化时能正确合并这些修改。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">resolveModifiedOptions</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="title class_">Ctor</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> modified;</span><br><span class="line">  <span class="keyword">const</span> latest = <span class="title class_">Ctor</span>.<span class="property">options</span>;     <span class="comment">// 当前构造函数的选项</span></span><br><span class="line">  <span class="keyword">const</span> sealed = <span class="title class_">Ctor</span>.<span class="property">sealedOptions</span>; <span class="comment">// 构造函数创建时被“密封”的原始选项副本</span></span><br><span class="line">  <span class="comment">// 遍历所有选项键，对比最新值和密封值是否一致</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> latest) &#123;</span><br><span class="line">    <span class="keyword">if</span> (latest[key] !== sealed[key]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!modified) modified = &#123;&#125;;</span><br><span class="line">      modified[key] = latest[key]; <span class="comment">// 记录被修改的选项</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> modified; <span class="comment">// 返回被修改的选项集合（若无修改返回 null）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="关键设计思想总结"><a href="#关键设计思想总结" class="headerlink" title="关键设计思想总结"></a><strong>关键设计思想总结</strong></h4><ol>
<li><strong>性能优化</strong>：<ul>
<li><code>initInternalComponent</code> 通过原型继承 (<code>Object.create</code>) 和直接赋值，避免深拷贝和动态枚举，提升内部组件初始化速度。</li>
<li><code>resolveConstructorOptions</code> 通过缓存机制 (<code>superOptions</code>) 减少重复合并开销。</li>
</ul>
</li>
<li><strong>继承与动态更新</strong>：<ul>
<li>处理通过 <code>Vue.extend</code> 继承的子类，递归解析父类选项，确保全局配置变更（如 <code>Vue.config.optionMergeStrategies</code>）能正确传递。</li>
<li>通过 <code>sealedOptions</code> 对比检测子类选项的动态修改（如手动修改 <code>Component.options</code>），保证合并结果准确。</li>
</ul>
</li>
<li><strong>选项合并策略</strong>：<ul>
<li>内部组件和普通组件的选项合并路径分离，前者优化性能，后者通过 <code>mergeOptions</code> 处理复杂合并逻辑（如生命周期钩子合并为数组）。</li>
</ul>
</li>
</ol>
<h3 id="initProxy"><a href="#initProxy" class="headerlink" title="initProxy"></a>initProxy</h3><p>在开发环境下，通过 <code>initProxy</code> 设置实例的渲染代理（拦截模板中未定义的属性访问并警告）；生产环境直接使用实例自身作为代理。当获取属性时，<code>options.render &amp;&amp; options.render._withStripped</code>条件成立时使用特定的拦截函数去处理</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断传入的参数是否存在</span></span><br><span class="line"><span class="keyword">const</span> allowedGlobals = <span class="title function_">makeMap</span>(</span><br><span class="line">    <span class="string">&#x27;Infinity,undefined,NaN,isFinite,isNaN,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;parseFloat,parseInt,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;Math,Number,Date,Array,Object,Boolean,String,RegExp,Map,Set,JSON,Intl,&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;require&#x27;</span> <span class="comment">// for Webpack/Browserify</span></span><br><span class="line">  )  </span><br><span class="line"><span class="comment">// 该函数的作用就是判断对象是否具有某个属性。可以看到首先用in操作符判断这个属性是否存在于_renderProxy中,当不存在 &amp;&amp; (属性名不为字符串 || 属性名首字母为_) &amp;&amp; allowedGlobals(key)为false时,提示警告信息&#x27;属性或方法没有在实例上定义&#x27;</span></span><br><span class="line"><span class="keyword">const</span> hasHandler = &#123;</span><br><span class="line">    <span class="title function_">has</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> has = key <span class="keyword">in</span> target</span><br><span class="line">      <span class="comment">// 判断key名是否存在于allowedGlobals函数中生成的对象中 || (key名是string类型 &amp;&amp; 首字母是_)</span></span><br><span class="line">      <span class="keyword">const</span> isAllowed = <span class="title function_">allowedGlobals</span>(key) || (<span class="keyword">typeof</span> key === <span class="string">&#x27;string&#x27;</span> &amp;&amp; key.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;_&#x27;</span> &amp;&amp; !(key <span class="keyword">in</span> target.<span class="property">$data</span>))</span><br><span class="line">      <span class="comment">// 访问了一个没有定义在实例对象上(或原型链上)的属性 &amp;&amp; isAllowed为false提示警告</span></span><br><span class="line">      <span class="keyword">if</span> (!has &amp;&amp; !isAllowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> target.<span class="property">$data</span>) <span class="title function_">warnReservedPrefix</span>(target, key)</span><br><span class="line">        <span class="keyword">else</span> <span class="title function_">warnNonPresent</span>(target, key)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> has || !isAllowed</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 这个比较好理解,就是读取_renderProxy中的属性的时候,当属性名为字符串 &amp;&amp; 不存在_renderProxy中时提示警告信息&#x27;属性或方法没有在实例上定义&#x27;。</span></span><br><span class="line">  <span class="keyword">const</span> getHandler = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">&#x27;string&#x27;</span> &amp;&amp; !(key <span class="keyword">in</span> target)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> target.<span class="property">$data</span>) <span class="title function_">warnReservedPrefix</span>(target, key)</span><br><span class="line">        <span class="keyword">else</span> <span class="title function_">warnNonPresent</span>(target, key)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initProxy</span>(<span class="params">vm</span>) &#123;</span><br><span class="line">    <span class="comment">//判断是否支持ES6的Proxy或存在Proxy函数</span></span><br><span class="line">    <span class="keyword">const</span> hasProxy =<span class="keyword">typeof</span> <span class="title class_">Proxy</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Proxy</span>)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (hasProxy) &#123;</span><br><span class="line">      <span class="comment">// determine which proxy handler to use</span></span><br><span class="line">      <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">      <span class="comment">// _withStripped属性主要用于在开发环境中对render函数进行代理处理，以便在调用render函数时能够正确地处理未定义的属性或方法。</span></span><br><span class="line">      <span class="comment">// 当读取_renderProxy的属性时进行了拦截操作,当该属性存在render函数和 render._withStripped属性时,执行的是getHandler拦截函数;否则就是执行hasHandler拦截函数,</span></span><br><span class="line">      <span class="keyword">const</span> handlers = options.<span class="property">render</span> &amp;&amp; options.<span class="property">render</span>.<span class="property">_withStripped</span> ? getHandler : hasHandler</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(vm, handlers)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">_renderProxy</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 当访问_renderProxy上属性时会走getHandler或hasHandler,返回值或者抛出警告</span></span><br><span class="line"><span class="comment">// 当在页面中data中定义$a/_a,标签里直接使用$a/_a时，会报错 </span></span><br><span class="line"><span class="comment">// [Vue warn]: Property &quot;$a&quot; must be accessed with &quot;$data.$a&quot; because properties starting with &quot;$&quot; or &quot;_&quot; are not proxied in the Vue instance to prevent conflicts with Vue internals.</span></span><br><span class="line"><span class="comment">// [Vue warn]: Property &quot;_a&quot; must be accessed with &quot;$data._a&quot; because properties starting with &quot;$&quot; or &quot;_&quot; are not proxied in the Vue instance to prevent conflicts with Vue internals.</span></span><br></pre></td></tr></table></figure></div>

<h3 id="initLifecycle"><a href="#initLifecycle" class="headerlink" title="initLifecycle"></a>initLifecycle</h3><p>初始化实例的父子组件关系，挂载<code>$parent、$root、$children、$refs</code>等属性</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initLifecycle</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// locate first non-abstract parent</span></span><br><span class="line">  <span class="keyword">let</span> parent = options.<span class="property">parent</span></span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; !options.<span class="property">abstract</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (parent.<span class="property">$options</span>.<span class="property">abstract</span> &amp;&amp; parent.<span class="property">$parent</span>) &#123;</span><br><span class="line">      parent = parent.<span class="property">$parent</span></span><br><span class="line">    &#125;</span><br><span class="line">    parent.<span class="property">$children</span>.<span class="title function_">push</span>(vm)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$parent</span> = parent</span><br><span class="line">  vm.<span class="property">$root</span> = parent ? parent.<span class="property">$root</span> : vm</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">$children</span> = []</span><br><span class="line">  vm.<span class="property">$refs</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  vm.<span class="property">_provided</span> = parent ? parent.<span class="property">_provided</span> : <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  vm.<span class="property">_watcher</span> = <span class="literal">null</span></span><br><span class="line">  vm.<span class="property">_inactive</span> = <span class="literal">null</span></span><br><span class="line">  vm.<span class="property">_directInactive</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isMounted</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isDestroyed</span> = <span class="literal">false</span></span><br><span class="line">  vm.<span class="property">_isBeingDestroyed</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="initEvents"><a href="#initEvents" class="headerlink" title="initEvents"></a>initEvents</h3><ol>
<li><strong>初始化事件</strong>：<code>initEvents</code> 在组件实例化时调用，初始化 <code>_events</code> 容器，并处理父组件传递的事件。</li>
<li><strong>更新监听器</strong>：当父组件传递的事件变化时（如父组件重新渲染），调用 <code>updateComponentListeners</code>：<ul>
<li>通过 <code>updateListeners</code> 对比新旧监听器。</li>
<li>使用 <code>add</code>、<code>remove</code>、<code>createOnceHandler</code> 进行事件绑定&#x2F;解绑。</li>
</ul>
</li>
<li><strong>一次性事件</strong>：通过包装函数确保回调执行后自动解绑。</li>
</ol>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initEvents</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  vm.<span class="property">_events</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  vm.<span class="property">_hasHookEvent</span> = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> listeners = vm.<span class="property">$options</span>.<span class="property">_parentListeners</span> <span class="comment">// 获取父组件绑定在子组件上的事件监听器</span></span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    <span class="title function_">updateComponentListeners</span>(vm, listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">target</span>: <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">event, fn</span>) &#123;</span><br><span class="line">  target.$on(event, fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">remove</span>(<span class="params">event, fn</span>) &#123;</span><br><span class="line">  target.$off(event, fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createOnceHandler</span>(<span class="params">event, fn</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> _target = target</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">onceHandler</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = fn.<span class="title function_">apply</span>(<span class="literal">null</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">    <span class="keyword">if</span> (res !== <span class="literal">null</span>) &#123;</span><br><span class="line">      _target.$off(event, onceHandler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateComponentListeners</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">listeners</span>: <span class="title class_">Object</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">oldListeners</span>?: <span class="title class_">Object</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  target = vm</span><br><span class="line">  <span class="title function_">updateListeners</span>(</span><br><span class="line">    listeners,</span><br><span class="line">    oldListeners || &#123;&#125;,</span><br><span class="line">    add,</span><br><span class="line">    remove,</span><br><span class="line">    createOnceHandler,</span><br><span class="line">    vm</span><br><span class="line">  )</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><code>updateListeners</code>：Vue 内部工具函数，用于对比新旧监听器，调用 <code>add</code> 和 <code>remove</code> 进行增量更新。</p>
</li>
<li><p><strong>流程</strong>：</p>
<ol>
<li>遍历新监听器，对比旧监听器：<ul>
<li>若事件不存在于旧监听器，调用 <code>add</code> 添加。</li>
<li>若事件回调变化，先调用 <code>remove</code> 移除旧的，再 <code>add</code> 新的。</li>
</ul>
</li>
<li>遍历旧监听器，移除不存在于新监听器中的事件。</li>
</ol>
</li>
<li><p><strong>一次性事件处理</strong>：通过 <code>createOnceHandler</code> 生成包装函数，确保执行后自动解绑。</p>
</li>
<li><p><strong><code>target</code> 的作用</strong>：通过全局变量临时存储当前组件实例，使得 <code>add</code>、<code>remove</code>、<code>createOnceHandler</code> 能正确操作目标实例。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateListeners</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">on</span>: <span class="title class_">Object</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">oldOn</span>: <span class="title class_">Object</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">add</span>: <span class="title class_">Function</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">remove</span>: <span class="title class_">Function</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">createOnceHandler</span>: <span class="title class_">Function</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">vm</span>: <span class="title class_">Component</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> name, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = <span class="title function_">normalizeEvent</span>(name) <span class="comment">// 解析事件名中的修饰符（如 @click.once 解析为 &#123; name: &#x27;click&#x27;, once: true &#125;）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(cur)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Invalid handler for event &quot;<span class="subst">$&#123;event.name&#125;</span>&quot;: got `</span> + <span class="title class_">String</span>(cur),</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(cur.<span class="property">fns</span>)) &#123;</span><br><span class="line">        cur = on[name] = <span class="title function_">createFnInvoker</span>(cur, vm) <span class="comment">// 将用户提供的回调函数（可能是数组或单个函数）封装成统一格式的调用器（invoker），便于后续更新</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isTrue</span>(event.<span class="property">once</span>)) &#123;</span><br><span class="line">        cur = on[name] = <span class="title function_">createOnceHandler</span>(event.<span class="property">name</span>, cur, event.<span class="property">capture</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">add</span>(event.<span class="property">name</span>, cur, event.<span class="property">capture</span>, event.<span class="property">passive</span>, event.<span class="property">params</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.<span class="property">fns</span> = cur <span class="comment">// 当回调函数变化时，直接修改旧回调的 fns 属性，避免触发 DOM 事件解绑和重新绑定，优化性能。</span></span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="comment">// 旧事件不在新事件列表中时，调用 remove 解绑，确保不再监听无用事件。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(on[name])) &#123;</span><br><span class="line">      event = <span class="title function_">normalizeEvent</span>(name)</span><br><span class="line">      <span class="title function_">remove</span>(event.<span class="property">name</span>, oldOn[name], event.<span class="property">capture</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="initRender"><a href="#initRender" class="headerlink" title="initRender"></a>initRender</h3><p><code>initRender</code>方法在组件初始化阶段完成以下任务：</p>
<ul>
<li>初始化虚拟节点和静态树缓存。</li>
<li>解析父组件传递的插槽内容（普通和作用域插槽）。</li>
<li>绑定创建虚拟节点的工具方法（<code>_c</code>和<code>$createElement</code>）。</li>
<li>定义响应式的<code>$attrs</code>和<code>$listeners</code>，确保其只读性和响应性。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">xport <span class="keyword">function</span> <span class="title function_">initRender</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  vm.<span class="property">_vnode</span> = <span class="literal">null</span> <span class="comment">// the root of the child tree</span></span><br><span class="line">  vm.<span class="property">_staticTrees</span> = <span class="literal">null</span> <span class="comment">// v-once cached trees 缓存v-once标记的静态内容，避免重复渲染，提升性能。</span></span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = (vm.<span class="property">$vnode</span> = options.<span class="property">_parentVnode</span>!) <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line">  <span class="keyword">const</span> renderContext = parentVnode &amp;&amp; (parentVnode.<span class="property">context</span> <span class="keyword">as</span> <span class="title class_">Component</span>)</span><br><span class="line">  vm.<span class="property">$slots</span> = <span class="title function_">resolveSlots</span>(options.<span class="property">_renderChildren</span>, renderContext)</span><br><span class="line">  <span class="comment">// resolveSlots：将父组件传递的子节点（_renderChildren）转换为普通插槽（$slots），按插槽名分类。</span></span><br><span class="line">  vm.<span class="property">$scopedSlots</span> = parentVnode ? <span class="title function_">normalizeScopedSlots</span>(vm.<span class="property">$parent</span>!, parentVnode.<span class="property">data</span>!.<span class="property">scopedSlots</span>, vm.<span class="property">$slots</span>) </span><br><span class="line">  : emptyObject</span><br><span class="line">  <span class="comment">// normalizeScopedSlots：处理作用域插槽，确保与普通插槽兼容，最终合并到$scopedSlots。</span></span><br><span class="line">  <span class="comment">// _c 模板编译生成的渲染函数使用，最后一个参数false表示不对子节点进行标准化（编译时已处理）</span></span><br><span class="line">  vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)</span><br><span class="line">  <span class="comment">// $createElement 用户手写render函数时使用，true表示需要标准化子节点（如处理嵌套数组）。</span></span><br><span class="line">  vm.<span class="property">$createElement</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">true</span>)</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">const</span> parentData = parentVnode &amp;&amp; parentVnode.<span class="property">data</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// defineReactive：将$attrs和$listeners定义为响应式属性。</span></span><br><span class="line">  <span class="comment">// 参数5（true）：表示浅层响应式（仅对象本身变化触发，不深度观察内部属性）。</span></span><br><span class="line">  <span class="comment">// 参数4 customSetter：在开发环境下，若直接修改$attrs或$listeners（非通过父组件更新），触发警告。</span></span><br><span class="line">  <span class="comment">// isUpdatingChildComponent：Vue内部标志，避免在父组件更新子组件时误报警告。</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, (parentData &amp;&amp; parentData.<span class="property">attrs</span>) || emptyObject,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    )</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        !isUpdatingChildComponent &amp;&amp; <span class="title function_">warn</span>(<span class="string">`$listeners is readonly.`</span>, vm)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$attrs&#x27;</span>, (parentData &amp;&amp; parentData.<span class="property">attrs</span>) || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="title function_">defineReactive</span>(vm, <span class="string">&#x27;$listeners&#x27;</span>, options.<span class="property">_parentListeners</span> || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h4><p><code>createElement</code> 是 Vue 虚拟 DOM 的入口函数，负责参数适配和规范化配置，确保内部 <code>_createElement</code> 能正确生成 VNode。<code>_createElement</code> 函数是 Vue 虚拟 DOM 的核心，负责生成 <code>VNode</code>，也就是<code>h</code>函数。</p>
<ul>
<li><p><strong>动态组件支持</strong></p>
<p>通过 <code>data.is</code> 实现 <code>&lt;component :is&gt;</code> 的动态标签解析，灵活切换组件。</p>
</li>
<li><p><strong>子节点规范化策略</strong></p>
<ul>
<li><p><code>simpleNormalizeChildren</code>：仅处理一层数组嵌套，适用于编译生成的渲染函数（结构已知）。</p>
</li>
<li><p><code>normalizeChildren</code>：递归处理所有嵌套数组，适用于用户手写复杂结构的场景。</p>
</li>
</ul>
</li>
<li><p><strong>组件解析优先级</strong></p>
<ul>
<li>优先检查是否注册为组件，否则视为原生标签或未知元素，确保自定义组件和 <code>Web Components</code> 兼容。</li>
</ul>
</li>
<li><p><strong>命名空间处理</strong></p>
<ul>
<li>自动继承父组件的命名空间（如 SVG 内嵌套 <code>&lt;foreignObject&gt;</code>），确保 DOM 正确渲染。</li>
</ul>
</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tag</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">data</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">children</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">normalizationType</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">alwaysNormalize</span>: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 目的：当用户调用时省略 data 参数（如 h(&#x27;div&#x27;, [&#x27;child&#x27;])），此时第二个参数实际是 children。</span></span><br><span class="line">  <span class="comment">// 条件：data 是数组（如 [&#x27;child&#x27;]）或原始类型（如字符串 &#x27;text&#x27;）。</span></span><br><span class="line">  <span class="comment">// 操作：将参数后移：</span></span><br><span class="line">  <span class="comment">// 原 children → 赋值给 normalizationType（规范化类型）</span></span><br><span class="line">  <span class="comment">// 原 data → 赋值给 children（子节点）</span></span><br><span class="line">  <span class="comment">// data 置为 undefined（因为没有传递数据对象）。</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(data) || <span class="title function_">isPrimitive</span>(data)) &#123;</span><br><span class="line">    normalizationType = children</span><br><span class="line">    children = data</span><br><span class="line">    data = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(alwaysNormalize)) &#123;</span><br><span class="line">    normalizationType = <span class="variable constant_">ALWAYS_NORMALIZE</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_createElement</span>(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">_createElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tag</span>?: <span class="built_in">string</span> | <span class="title class_">Component</span> | <span class="title class_">Function</span> | <span class="title class_">Object</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">data</span>?: <span class="title class_">VNodeData</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">children</span>?: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">normalizationType</span>?: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 开发环境警告：禁止使用被观察的响应式对象作为 VNode 数据，VNode 数据应是纯对象，</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>((data <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__ob__</span>)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Avoid using observed data object as vnode data: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(</span></span></span><br><span class="line"><span class="subst"><span class="string">          data</span></span></span><br><span class="line"><span class="subst"><span class="string">        )&#125;</span>\n`</span> + <span class="string">&#x27;Always create fresh vnode data objects in each render!&#x27;</span>,</span><br><span class="line">        context</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// object syntax in v-bind</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(data.<span class="property">is</span>)) &#123;</span><br><span class="line">    tag = data.<span class="property">is</span> <span class="comment">// 动态组件语法 &lt;component :is=&quot;tag&quot;&gt;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!tag) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createEmptyVNode</span>() <span class="comment">// 无效标签返回空节点</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 非原始值不能作为key，key 必须是字符串或数字，确保高效 diff 算法。</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(data.<span class="property">key</span>) &amp;&amp; !<span class="title function_">isPrimitive</span>(data.<span class="property">key</span>)) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&#x27;Avoid using non-primitive value as key, &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;use string/number value instead.&#x27;</span>,</span><br><span class="line">      context</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// support single function children as default scoped slot</span></span><br><span class="line">  <span class="comment">// &lt;Child&gt;&#123;&#123; slotProps =&gt; ... &#125;&#125;&lt;/Child&gt; 简写语法。</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(children) &amp;&amp; <span class="title function_">isFunction</span>(children[<span class="number">0</span>])) &#123;</span><br><span class="line">    data = data || &#123;&#125;</span><br><span class="line">    data.<span class="property">scopedSlots</span> = &#123; <span class="attr">default</span>: children[<span class="number">0</span>] &#125; <span class="comment">// 单个函数作为默认插槽</span></span><br><span class="line">    children.<span class="property">length</span> = <span class="number">0</span> <span class="comment">// 清空子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// SIMPLE_NORMALIZE：用于编译生成的渲染函数（已知子节点结构）。</span></span><br><span class="line">  <span class="comment">// ALWAYS_NORMALIZE：用于手写渲染函数（需处理复杂嵌套）。</span></span><br><span class="line">  <span class="keyword">if</span> (normalizationType ===  <span class="variable constant_">ALWAYS_NORMALIZE</span>) &#123;</span><br><span class="line">    children = <span class="title function_">normalizeChildren</span>(children) <span class="comment">// 完全规范化（递归处理嵌套数组）</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === <span class="variable constant_">SIMPLE_NORMALIZE</span>) &#123;</span><br><span class="line">    children = <span class="title function_">simpleNormalizeChildren</span>(children) <span class="comment">// 简单规范化（拍平一层数组）</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Ctor</span></span><br><span class="line">    <span class="comment">// 处理字符串标签（HTML 元素或组件）</span></span><br><span class="line">    ns = (context.<span class="property">$vnode</span> &amp;&amp; context.<span class="property">$vnode</span>.<span class="property">ns</span>) || config.<span class="title function_">getTagNamespace</span>(tag) <span class="comment">// // 获取命名空间（如 SVG）</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="title function_">isReservedTag</span>(tag)) &#123;</span><br><span class="line">      <span class="comment">// 平台内置标签（如 div、svg）</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(data.<span class="property">nativeOn</span>) &amp;&amp; data.<span class="property">tag</span> !== <span class="string">&#x27;component&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The .native modifier for v-on is only valid on components but it was used on &lt;<span class="subst">$&#123;tag&#125;</span>&gt;.`</span>, context)</span><br><span class="line">      &#125;</span><br><span class="line">      vnode = <span class="keyword">new</span> <span class="title class_">VNode</span>(config.<span class="title function_">parsePlatformTagName</span>(tag), data, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>, context)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!data || !data.<span class="property">pre</span>) &amp;&amp; <span class="title function_">isDef</span>((<span class="title class_">Ctor</span> = <span class="title function_">resolveAsset</span>(context.<span class="property">$options</span>, <span class="string">&#x27;components&#x27;</span>, tag)))) &#123;</span><br><span class="line">      <span class="comment">// 解析为注册的组件</span></span><br><span class="line">      vnode = <span class="title function_">createComponent</span>(<span class="title class_">Ctor</span>, data, context, children, tag)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 未知标签（可能是自定义元素或未注册组件）</span></span><br><span class="line">      vnode = <span class="keyword">new</span> <span class="title class_">VNode</span>(tag, data, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>, context)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// direct component options / constructor</span></span><br><span class="line">    vnode = <span class="title function_">createComponent</span>(tag <span class="keyword">as</span> <span class="built_in">any</span>, data, context, children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回多个根节点（Vue 2 需要单个根节点，Vue 3 支持片段）</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(ns)) <span class="title function_">applyNS</span>(vnode, ns) <span class="comment">// 应用命名空间（如 SVG 子元素继承）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) <span class="title function_">registerDeepBindings</span>(data) <span class="comment">// 注册深层绑定（如动态 class/style）</span></span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createEmptyVNode</span>() <span class="comment">// 兜底空节点</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="resolveSlots"><a href="#resolveSlots" class="headerlink" title="resolveSlots"></a>resolveSlots</h4><p>将子节点按具名插槽和默认插槽分类，清理无用属性，过滤空白内容，为后续渲染提供结构化插槽数据。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveSlots</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">children</span>: <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; | <span class="literal">null</span> | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): &#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#125; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!children || !children.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">slots</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = children.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> child = children[i]</span><br><span class="line">    <span class="keyword">const</span> data = child.<span class="property">data</span></span><br><span class="line">    <span class="comment">// Vue2的具名插槽通过slot属性标记（如&lt;div slot=&quot;header&quot;&gt;）。</span></span><br><span class="line">    <span class="comment">// 在Vue编译阶段，slot属性会被提取到data.slot中（供后续插槽解析使用）。</span></span><br><span class="line">    <span class="comment">// 残留的data.attrs.slot是编译后的“冗余属性”，需要删除，否则它会作为普通HTML属性被渲染到DOM上。</span></span><br><span class="line">    <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">attrs</span> &amp;&amp; data.<span class="property">attrs</span>.<span class="property">slot</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> data.<span class="property">attrs</span>.<span class="property">slot</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 确认子节点在当前组件上下文中渲染，且 data.slot 存在（具名插槽）。</span></span><br><span class="line">    <span class="keyword">if</span> ((child.<span class="property">context</span> === context || child.<span class="property">fnContext</span> === context) &amp;&amp; data &amp;&amp; data.<span class="property">slot</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> name = data.<span class="property">slot</span></span><br><span class="line">      <span class="keyword">const</span> slot = slots[name] || (slots[name] = []) </span><br><span class="line">      <span class="comment">// 提取插槽名称 name，创建对应数组（若不存在）。</span></span><br><span class="line">      <span class="comment">// 如果是 &lt;template&gt; 标签，将其子节点展开后加入插槽数组；否则直接加入子节点。</span></span><br><span class="line">      <span class="keyword">if</span> (child.<span class="property">tag</span> === <span class="string">&#x27;template&#x27;</span>) &#123;</span><br><span class="line">        slot.<span class="property">push</span>.<span class="title function_">apply</span>(slot, child.<span class="property">children</span> || [])</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        slot.<span class="title function_">push</span>(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ;(slots.<span class="property">default</span> || (slots.<span class="property">default</span> = [])).<span class="title function_">push</span>(child) <span class="comment">// 不满足具名插槽条件的子节点，加入 default 插槽。</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 遍历所有插槽，删除仅含空白内容（如空格、换行）的插槽，优化渲染。</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> slots) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slots[name].<span class="title function_">every</span>(isWhitespace)) &#123;</span><br><span class="line">      <span class="keyword">delete</span> slots[name]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> slots</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="normalizeScopedSlots"><a href="#normalizeScopedSlots" class="headerlink" title="normalizeScopedSlots"></a>normalizeScopedSlots</h4><ol>
<li><strong>统一插槽格式</strong>：<br>将作用域插槽和普通插槽统一为可执行的渲染函数，简化后续使用。</li>
<li><strong>性能优化</strong>：<ul>
<li>通过 <code>_normalized</code> 缓存避免重复计算。</li>
<li>通过 <code>$stable</code> 和 <code>$key</code> 实现插槽复用，减少不必要的子组件更新。</li>
</ul>
</li>
<li><strong>代理普通插槽</strong>：<br>让普通插槽可以像作用域插槽一样通过函数调用（如 <code>this.$scopedSlots.default()</code>），保持接口一致性。</li>
</ol>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">normalizeScopedSlots</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">ownerVm</span>: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">scopedSlots</span>: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">Function</span> &#125; | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">normalSlots</span>: &#123; [key: <span class="built_in">string</span>]: VNode[] &#125;,</span></span><br><span class="line"><span class="params">  <span class="attr">prevScopedSlots</span>?: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">Function</span> &#125;</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> res</span><br><span class="line">  <span class="keyword">const</span> hasNormalSlots = <span class="title class_">Object</span>.<span class="title function_">keys</span>(normalSlots).<span class="property">length</span> &gt; <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> isStable = scopedSlots ? !!scopedSlots.<span class="property">$stable</span> : !hasNormalSlots</span><br><span class="line">  <span class="comment">// 若 scopedSlots 存在且声明了 $stable: true，或不存在普通插槽，则认为插槽是“稳定”的，无需频繁更新。</span></span><br><span class="line">  <span class="keyword">const</span> key = scopedSlots &amp;&amp; scopedSlots.<span class="property">$key</span></span><br><span class="line">  <span class="keyword">if</span> (!scopedSlots) &#123;</span><br><span class="line">    res = &#123;&#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scopedSlots.<span class="property">_normalized</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果已经对 scopedSlots 做过规范化（标记 _normalized），直接返回缓存结果，避免重复计算。</span></span><br><span class="line">    <span class="keyword">return</span> scopedSlots.<span class="property">_normalized</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isStable &amp;&amp; prevScopedSlots &amp;&amp; prevScopedSlots !== emptyObject &amp;&amp; key === prevScopedSlots.<span class="property">$key</span> &amp;&amp;    !hasNormalSlots &amp;&amp; !prevScopedSlots.<span class="property">$hasNormal</span>) &#123;</span><br><span class="line">    <span class="comment">// 若当前作用域插槽是稳定的（isStable），且与上一次的 prevScopedSlots 具有相同的 $key，且没有普通插槽，则直接复用上一次的结果，跳过规范化过程。</span></span><br><span class="line">    <span class="keyword">return</span> prevScopedSlots</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> scopedSlots) &#123;</span><br><span class="line">      <span class="comment">// 对每个非$开头的插槽（排除内部属性），调用normalizeScopedSlot规范化，生成可执行的渲染函数。</span></span><br><span class="line">      <span class="keyword">if</span> (scopedSlots[key] &amp;&amp; key[<span class="number">0</span>] !== <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">        res[key] = <span class="title function_">normalizeScopedSlot</span>(</span><br><span class="line">          ownerVm,</span><br><span class="line">          normalSlots,</span><br><span class="line">          key,</span><br><span class="line">          scopedSlots[key]</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将普通插槽（如default）通过proxyNormalSlot代理到res中，使得父组件可以通过作用域插槽的接口统一访问两种插槽。</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> normalSlots) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> res)) &#123;</span><br><span class="line">      res[key] = <span class="title function_">proxyNormalSlot</span>(normalSlots, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果scopedSlots是可拓展的，将规范化后的结果 res 缓存到原 scopedSlots 的 _normalized 属性中，供后续快速访问。</span></span><br><span class="line">  <span class="keyword">if</span> (scopedSlots &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">isExtensible</span>(scopedSlots)) &#123;</span><br><span class="line">    scopedSlots.<span class="property">_normalized</span> = res</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 使用 Object.defineProperty 定义不可枚举的属性，避免被意外遍历或修改。</span></span><br><span class="line">  <span class="title function_">def</span>(res, <span class="string">&#x27;$stable&#x27;</span>, isStable)</span><br><span class="line">  <span class="title function_">def</span>(res, <span class="string">&#x27;$key&#x27;</span>, key)</span><br><span class="line">  <span class="title function_">def</span>(res, <span class="string">&#x27;$hasNormal&#x27;</span>, hasNormalSlots)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">proxyNormalSlot</span>(<span class="params">slots, key</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> slots[key]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">def</span>(<span class="params"><span class="attr">obj</span>: <span class="title class_">Object</span>, <span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">any</span>, <span class="attr">enumerable</span>?: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">value</span>: val,</span><br><span class="line">    <span class="attr">enumerable</span>: !!enumerable,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="initInjections"><a href="#initInjections" class="headerlink" title="initInjections"></a>initInjections</h3><p><code>initInjections</code> 方法的作用是：</p>
<ol>
<li>解析组件的 <code>inject</code> 配置，从祖先组件获取对应值。</li>
<li>将注入值绑定到组件实例，使其成为响应式属性。</li>
<li>在开发环境下阻止直接修改注入值，维护单向数据流。</li>
</ol>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initInjections</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 解析组件配置中的 `inject` 选项，获取注入的值</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">resolveInject</span>(vm.<span class="property">$options</span>.<span class="property">inject</span>, vm)</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="comment">// 临时关闭响应式观察（避免对注入值进行深度响应式处理）</span></span><br><span class="line">    <span class="comment">// Vue 内部通过toggleObserving函数控制是否对数据对象进行递归响应式观察。此处关闭观察，因为：</span></span><br><span class="line">    <span class="comment">// 性能优化：注入的值可能已经是响应式的（由祖先组件提供），避免重复处理。</span></span><br><span class="line">    <span class="comment">// 避免意外行为：防止对注入的原始值（如非对象类型的值）进行不必要的观察。</span></span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// 遍历注入的键值对，开发环境下，为注入属性添加自定义 setter 警告</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(result).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">defineReactive</span>(vm, key, result[key], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Avoid mutating an injected value directly since the changes will be `</span> +</span><br><span class="line">              <span class="string">`overwritten whenever the provided component re-renders. `</span> +</span><br><span class="line">              <span class="string">`injection being mutated: &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>,</span><br><span class="line">            vm</span><br><span class="line">          )</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">defineReactive</span>(vm, key, result[key])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 恢复响应式观察</span></span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="initState"><a href="#initState" class="headerlink" title="initState"></a>initState</h3><p><code>initState</code>是组件状态初始化的核心入口，负责：</p>
<ul>
<li>按顺序处理props、setup、methods、data、computed和watch。</li>
<li>将各类状态转化为响应式数据。</li>
<li>确保组件实例上下文（<code>this</code>）能正确访问所有状态和方法。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initState</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> opts = vm.<span class="property">$options</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">props</span>) <span class="title function_">initProps</span>(vm, opts.<span class="property">props</span>) <span class="comment">// props需在data之前初始化，因为data可能依赖props的值。</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Composition API</span></span><br><span class="line">  <span class="title function_">initSetup</span>(vm)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">methods</span>) <span class="title function_">initMethods</span>(vm, opts.<span class="property">methods</span>)</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ob = <span class="title function_">observe</span>((vm.<span class="property">_data</span> = &#123;&#125;))</span><br><span class="line">    ob &amp;&amp; ob.<span class="property">vmCount</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">computed</span>) <span class="title function_">initComputed</span>(vm, opts.<span class="property">computed</span>) <span class="comment">// 计算属性可能依赖data或props，故需在它们之后初始化。</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initProps"><a href="#initProps" class="headerlink" title="initProps"></a>initProps</h4><p><code>initProps</code>的核心逻辑是：</p>
<ol>
<li>提取并校验父组件传递的props。</li>
<li>将其转为浅响应式对象，代理到组件实例。</li>
<li>在开发环境下防御非法操作（保留属性名、直接修改）。</li>
<li>优化性能和维护单向数据流。</li>
</ol>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initProps</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">propsOptions</span>: <span class="title class_">Object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> propsData = vm.<span class="property">$options</span>.<span class="property">propsData</span> || &#123;&#125; <span class="comment">// 从组件实例的配置中提取父组件传递的实际prop值</span></span><br><span class="line">  <span class="keyword">const</span> props = (vm.<span class="property">_props</span> = <span class="title function_">shallowReactive</span>(&#123;&#125;)) <span class="comment">// 使用Vue 3的浅响应式API，仅对props对象的第一层属性进行响应式处理，优化性能并避免深层意外修改。</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">keys</span>: <span class="built_in">string</span>[] = (vm.<span class="property">$options</span>.<span class="property">_propKeys</span> = []) <span class="comment">// 缓存所有prop的键名到数组，后续更新props时可直接遍历数组，避免动态枚举对象键，提高效率。</span></span><br><span class="line">  <span class="keyword">const</span> isRoot = !vm.<span class="property">$parent</span></span><br><span class="line">  <span class="keyword">if</span> (!isRoot) &#123;</span><br><span class="line">    <span class="title function_">toggleObserving</span>(<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">    keys.<span class="title function_">push</span>(key)</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title function_">validateProp</span>(key, propsOptions, propsData, vm)</span><br><span class="line">    <span class="comment">// 校验prop类型、默认值、必填性等，返回处理后的值。例如：</span></span><br><span class="line">    <span class="comment">// 若父组件未传值但prop有default，使用默认值。</span></span><br><span class="line">    <span class="comment">// 类型不匹配时，开发环境警告。</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> hyphenatedKey = <span class="title function_">hyphenate</span>(key) <span class="comment">// 检查prop名称是否为HTML保留属性（如class、style），防止命名冲突。</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isReservedAttribute</span>(hyphenatedKey) || config.<span class="title function_">isReservedAttr</span>(hyphenatedKey)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`&quot;<span class="subst">$&#123;hyphenatedKey&#125;</span>&quot; is a reserved attribute and cannot be used as component prop.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">defineReactive</span>(props, key, value, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 将prop定义为响应式属性</span></span><br><span class="line">          <span class="keyword">if</span> (!isRoot &amp;&amp; !isUpdatingChildComponent) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Avoid mutating a prop directly since the value will be `</span> +</span><br><span class="line">                <span class="string">`overwritten whenever the parent component re-renders. `</span> +</span><br><span class="line">                <span class="string">`Instead, use a data or computed property based on the prop&#x27;s `</span> +</span><br><span class="line">                <span class="string">`value. Prop being mutated: &quot;<span class="subst">$&#123;key&#125;</span>&quot;`</span>,</span><br><span class="line">              vm</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="literal">true</span> <span class="comment">/* shallow */</span></span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">defineReactive</span>(props, key, value, <span class="literal">undefined</span>, <span class="literal">true</span> <span class="comment">/* shallow */</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">`_props`</span>, key) <span class="comment">// 将vm._props[key]代理到vm[key]，允许通过this.key直接访问prop，无需this._props.key。</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">toggleObserving</span>(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initSetup"><a href="#initSetup" class="headerlink" title="initSetup"></a>initSetup</h4><p><code>initSetup</code> 是 Vue 3 Composition API 的核心实现之一，负责：</p>
<ul>
<li>执行 <code>setup</code> 函数并管理其上下文。</li>
<li>处理返回值（渲染函数或响应式对象）。</li>
<li>将响应式状态代理到组件实例，优化模板访问。</li>
<li>提供开发环境警告与错误处理。</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initSetup</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> options = vm.<span class="property">$options</span></span><br><span class="line">  <span class="keyword">const</span> setup = options.<span class="property">setup</span></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = (vm.<span class="property">_setupContext</span> = <span class="title function_">createSetupContext</span>(vm)) <span class="comment">// 生成包含 attrs、slots、emit 等属性的上下文对象，供 setup 函数使用</span></span><br><span class="line">    <span class="title function_">setCurrentInstance</span>(vm) <span class="comment">// 设置当前组件实例，确保在 setup 中通过 getCurrentInstance() 获取正确实例</span></span><br><span class="line">    <span class="title function_">pushTarget</span>() <span class="comment">// 暂停依赖收集（避免 setup 执行期间收集到父组件的依赖），确保响应式系统正确追踪当前组件。</span></span><br><span class="line">    <span class="comment">// 执行 setup 函数，并处理可能的错误</span></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">invokeWithErrorHandling</span>(</span><br><span class="line">      setup,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      [vm.<span class="property">_props</span> || <span class="title function_">shallowReactive</span>(&#123;&#125;), ctx],</span><br><span class="line">      vm,</span><br><span class="line">      <span class="string">`setup`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="title function_">popTarget</span>() <span class="comment">// 恢复依赖收集</span></span><br><span class="line">    <span class="title function_">setCurrentInstance</span>() <span class="comment">// 清除当前实例引用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回函数：视为渲染函数，覆盖 options.render，允许 setup 替代 render 选项。</span></span><br><span class="line">    <span class="comment">// 返回对象：</span></span><br><span class="line">    <span class="comment">// 	       普通对象：将每个属性代理到组件实例（vm），自动解包 ref 值（无需 .value）。</span></span><br><span class="line">    <span class="comment">//         编译生成对象（__sfc 标记）：代理到 vm._setupProxy，供编译后的渲染函数高效访问。</span></span><br><span class="line">    <span class="comment">//         保留属性名：开发环境警告避免使用 _ 或 $ 开头的变量名（可能与 Vue 内部属性冲突）。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isFunction</span>(setupResult)) &#123;</span><br><span class="line">      <span class="comment">// render function</span></span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      options.<span class="property">render</span> = setupResult</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isObject</span>(setupResult)) &#123;</span><br><span class="line">      <span class="comment">// bindings</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; setupResult <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`setup() should not return VNodes directly - `</span> +</span><br><span class="line">            <span class="string">`return a render function instead.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      vm.<span class="property">_setupState</span> = setupResult</span><br><span class="line">      <span class="comment">// __sfc indicates compiled bindings from &lt;script setup&gt;</span></span><br><span class="line">      <span class="comment">// 处理非编译生成的绑定（普通 setup 返回）</span></span><br><span class="line">      <span class="keyword">if</span> (!setupResult.<span class="property">__sfc</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupResult) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!<span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">            <span class="comment">// 跳过以 _ 或 $ 开头的保留属性，将每个属性代理到组件实例，自动解包 ref</span></span><br><span class="line">            <span class="title function_">proxyWithRefUnwrap</span>(vm, setupResult, key)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(<span class="string">`Avoid using variables that start with _ or $ in setup().`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// exposed for compiled render fn</span></span><br><span class="line">        <span class="comment">// 处理编译生成的绑定（如 &lt;script setup&gt; 语法）</span></span><br><span class="line">        <span class="keyword">const</span> proxy = (vm.<span class="property">_setupProxy</span> = &#123;&#125;)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> setupResult) &#123;</span><br><span class="line">          <span class="keyword">if</span> (key !== <span class="string">&#x27;__sfc&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_">proxyWithRefUnwrap</span>(proxy, setupResult, key)</span><br><span class="line">            <span class="comment">// 将 setup 返回的响应式属性（如 ref、reactive）代理到组件实例，并在访问时自动解包 ref 值</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__ &amp;&amp; setupResult !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`setup() should return an object. Received: <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">          setupResult === <span class="literal">null</span> ? <span class="string">&#x27;null&#x27;</span> : <span class="keyword">typeof</span> setupResult</span></span></span><br><span class="line"><span class="subst"><span class="string">        &#125;</span>`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initMethods"><a href="#initMethods" class="headerlink" title="initMethods"></a>initMethods</h4><p>用于将组件选项中定义的 <strong>方法（methods）</strong> 初始化到组件实例（<code>vm</code>）上，并进行开发环境下的校验，确保方法命名合法且不与现有属性冲突。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initMethods</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">methods</span>: <span class="title class_">Object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">$options</span>.<span class="property">props</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has type &quot;<span class="subst">$&#123;<span class="keyword">typeof</span> methods[</span></span></span><br><span class="line"><span class="subst"><span class="string">            key</span></span></span><br><span class="line"><span class="subst"><span class="string">          ]&#125;</span>&quot; in the component definition. `</span> +</span><br><span class="line">            <span class="string">`Did you reference the function correctly?`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a prop.`</span>, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 以 _ 开头的属性（如 _init）是 Vue 内部私有方法。</span></span><br><span class="line">      <span class="comment">// 以 $ 开头的属性（如 $emit）是 Vue 公有实例方法。</span></span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm &amp;&amp; <span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; conflicts with an existing Vue instance method. `</span> +</span><br><span class="line">            <span class="string">`Avoid defining component methods that start with _ or $.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vm[key] = <span class="keyword">typeof</span> methods[key] !== <span class="string">&#x27;function&#x27;</span> ? noop : <span class="title function_">bind</span>(methods[key], vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initData"><a href="#initData" class="headerlink" title="initData"></a>initData</h4><p>用于将组件选项中定义的 <strong>数据（data）</strong> 初始化到组件实例（<code>vm</code>）上，并进行开发环境下的校验，确保数据命名合法且不与现有属性和方法冲突。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">data</span>: <span class="built_in">any</span> = vm.<span class="property">$options</span>.<span class="property">data</span></span><br><span class="line">  data = vm.<span class="property">_data</span> = <span class="title function_">isFunction</span>(data) ? <span class="title function_">getData</span>(data, vm) : data || &#123;&#125;</span><br><span class="line">  <span class="comment">// 函数型 data：调用 getData(data, vm) 执行函数，确保每个组件实例有独立数据对象。</span></span><br><span class="line">  <span class="comment">// 非函数 data：直接使用（非生产环境会警告，因可能导致多实例共享数据）。</span></span><br><span class="line">  <span class="comment">// 默认值：若无 data，初始化为空对象 &#123;&#125;。</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(data)) &#123;</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;data functions should return an object:\n&#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;https://v2.vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#x27;</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy data on instance</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data)</span><br><span class="line">  <span class="keyword">const</span> props = vm.<span class="property">$options</span>.<span class="property">props</span></span><br><span class="line">  <span class="keyword">const</span> methods = vm.<span class="property">$options</span>.<span class="property">methods</span></span><br><span class="line">  <span class="keyword">let</span> i = keys.<span class="property">length</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods &amp;&amp; <span class="title function_">hasOwn</span>(methods, key)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`Method &quot;<span class="subst">$&#123;key&#125;</span>&quot; has already been defined as a data property.`</span>, vm)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (props &amp;&amp; <span class="title function_">hasOwn</span>(props, key)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`The data property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already declared as a prop. `</span> +</span><br><span class="line">            <span class="string">`Use prop default value instead.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">isReserved</span>(key)) &#123;</span><br><span class="line">      <span class="title function_">proxy</span>(vm, <span class="string">`_data`</span>, key) <span class="comment">// 将vm._data[key]代理到vm[key]，允许通过this.key直接访问data，无需this._data.key。</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe data</span></span><br><span class="line">  <span class="keyword">const</span> ob = <span class="title function_">observe</span>(data)</span><br><span class="line">  <span class="comment">// 作用：递归将 data 对象转换为响应式（通过 Object.defineProperty 或 Proxy）。</span></span><br><span class="line">  <span class="comment">// 返回值：返回一个 Observer 实例，用于管理依赖收集和通知。</span></span><br><span class="line">  ob &amp;&amp; ob.<span class="property">vmCount</span>++ <span class="comment">// 记录当前数据对象被多少组件实例引用（用于根数据对象的共享检测）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initComputed"><a href="#initComputed" class="headerlink" title="initComputed"></a>initComputed</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initComputed</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">computed</span>: <span class="title class_">Object</span></span>) &#123;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> watchers = (vm.<span class="property">_computedWatchers</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>))</span><br><span class="line">  <span class="comment">// computed properties are just getters during SSR</span></span><br><span class="line">  <span class="keyword">const</span> isSSR = <span class="title function_">isServerRendering</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">    <span class="keyword">const</span> userDef = computed[key]</span><br><span class="line">    <span class="keyword">const</span> getter = <span class="title function_">isFunction</span>(userDef) ? userDef : userDef.<span class="property">get</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`Getter is missing for computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot;.`</span>, vm)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isSSR) &#123;</span><br><span class="line">      <span class="comment">// create internal watcher for the computed property.</span></span><br><span class="line">      watchers[key] = <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">        vm,</span><br><span class="line">        getter || noop,</span><br><span class="line">        noop,</span><br><span class="line">        computedWatcherOptions</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// component-defined computed properties are already defined on the</span></span><br><span class="line">    <span class="comment">// component prototype. We only need to define computed properties defined</span></span><br><span class="line">    <span class="comment">// at instantiation here.</span></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      <span class="title function_">defineComputed</span>(vm, key, userDef)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm.<span class="property">$data</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined in data.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">props</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">props</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined as a prop.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">methods</span> &amp;&amp; key <span class="keyword">in</span> vm.<span class="property">$options</span>.<span class="property">methods</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`The computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; is already defined as a method.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defineComputed</span>(<span class="params"><span class="attr">target</span>: <span class="built_in">any</span>, <span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">userDef</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; | (() =&gt; <span class="built_in">any</span>)</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> shouldCache = !<span class="title function_">isServerRendering</span>()</span><br><span class="line">  <span class="comment">// 如果userDef是函数类型（简化的getter）</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isFunction</span>(userDef)) &#123;</span><br><span class="line">    <span class="comment">// createComputedGetter：创建带依赖追踪和缓存机制的getter</span></span><br><span class="line">    <span class="comment">// createGetterInvoker：直接调用用户函数，无缓存</span></span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = shouldCache ? <span class="title function_">createComputedGetter</span>(key) : <span class="title function_">createGetterInvoker</span>(userDef)</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = noop <span class="comment">// 空函数，表示该计算属性不可被赋值</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// // 处理对象形式的userDef（包含get/set）</span></span><br><span class="line">    sharedPropertyDefinition.<span class="property">get</span> = userDef.<span class="property">get</span></span><br><span class="line">      ? shouldCache &amp;&amp; userDef.<span class="property">cache</span> !== <span class="literal">false</span></span><br><span class="line">        ? <span class="title function_">createComputedGetter</span>(key)</span><br><span class="line">        : <span class="title function_">createGetterInvoker</span>(userDef.<span class="property">get</span>)</span><br><span class="line">      : noop</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = userDef.<span class="property">set</span> || noop</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开发环境下对缺失setter的警告处理</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; sharedPropertyDefinition.<span class="property">set</span> === noop) &#123;</span><br><span class="line">    sharedPropertyDefinition.<span class="property">set</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Computed property &quot;<span class="subst">$&#123;key&#125;</span>&quot; was assigned to but it has no setter.`</span>,</span><br><span class="line">        <span class="variable language_">this</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 使用Object.defineProperty将计算属性定义到目标对象</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createComputedGetter</span>(<span class="params">key</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="variable language_">this</span>.<span class="property">_computedWatchers</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_computedWatchers</span>[key]</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="keyword">if</span> (watcher.<span class="property">dirty</span>) &#123; <span class="comment">// 通过 dirty 标志控制缓存，dirty: true 表示依赖的数据已变化，需重新计算</span></span><br><span class="line">        watcher.<span class="title function_">evaluate</span>() <span class="comment">// 执行计算属性的 getter 函数，更新 value，并将 dirty 置为 false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123; <span class="comment">// Dep.target 是当前正在计算的上级 Watcher（如渲染 Watcher）</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="property">onTrack</span>) &#123;</span><br><span class="line">          <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">onTrack</span>(&#123; <span class="comment">// 在开发模式下，触发 onTrack 钩子，帮助开发者调试依赖追踪</span></span><br><span class="line">            <span class="attr">effect</span>: <span class="title class_">Dep</span>.<span class="property">target</span>,</span><br><span class="line">            <span class="attr">target</span>: <span class="variable language_">this</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">TrackOpTypes</span>.<span class="property">GET</span>,</span><br><span class="line">            key</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        watcher.<span class="title function_">depend</span>() <span class="comment">// 将计算属性 Watcher 的依赖（子依赖）添加到父级 Watcher 的依赖列表中。</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.<span class="property">value</span> <span class="comment">// 若缓存有效（dirty: false），直接返回缓存值；否则返回重新计算后的值。</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createGetterInvoker</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">computedGetter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fn.<span class="title function_">call</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="initWatch"><a href="#initWatch" class="headerlink" title="initWatch"></a>initWatch</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initWatch</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span>, <span class="attr">watch</span>: <span class="title class_">Object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = watch[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray</span>(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handler.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">createWatcher</span>(vm, key, handler[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">createWatcher</span>(vm, key, handler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createWatcher</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">expOrFn</span>: <span class="built_in">string</span> | (() =&gt; <span class="built_in">any</span>),</span></span><br><span class="line"><span class="params">  <span class="attr">handler</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">Object</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(handler)) &#123;</span><br><span class="line">    options = handler <span class="comment">// 将整个对象作为选项（如 deep、immediate）&#123; handler: fn, deep: true &#125;</span></span><br><span class="line">    handler = handler.<span class="property">handler</span> <span class="comment">// 提取真正的回调函数</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    handler = vm[handler] <span class="comment">// 从组件实例中获取方法（如 vm.onMessageChange）</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 调用 $watch 创建 Watcher</span></span><br><span class="line">  <span class="keyword">return</span> vm.$watch(expOrFn, handler, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h3 id="initProvide"><a href="#initProvide" class="headerlink" title="initProvide"></a>initProvide</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initProvide</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> provideOption = vm.<span class="property">$options</span>.<span class="property">provide</span></span><br><span class="line">  <span class="keyword">if</span> (provideOption) &#123;</span><br><span class="line">    <span class="keyword">const</span> provided = <span class="title function_">isFunction</span>(provideOption) ? provideOption.<span class="title function_">call</span>(vm) : provideOption</span><br><span class="line">    <span class="comment">// 若provide是函数（如provide() &#123; return &#123; data: this.message &#125; &#125;），调用它并将组件实例vm作为上下文，返回结果。</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isObject</span>(provided)) &#123; </span><br><span class="line">    <span class="comment">// 若provided不是对象（如provide: 123），直接终止处理。provide必须提供键值对结构供子孙组件注入。</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> source = <span class="title function_">resolveProvided</span>(vm)</span><br><span class="line">    <span class="comment">// IE9 doesn&#x27;t support Object.getOwnPropertyDescriptors so we have to</span></span><br><span class="line">    <span class="comment">// iterate the keys ourselves.</span></span><br><span class="line">    <span class="keyword">const</span> keys = hasSymbol ? <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(provided) : <span class="title class_">Object</span>.<span class="title function_">keys</span>(provided)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = keys[i]</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(source, key, <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(provided, key)!)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveProvided</span>(<span class="params"><span class="attr">vm</span>: <span class="title class_">Component</span></span>): <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// by default an instance inherits its parent&#x27;s provides object</span></span><br><span class="line">  <span class="comment">// but when it needs to provide values of its own, it creates its</span></span><br><span class="line">  <span class="comment">// own provides object using parent provides object as prototype.</span></span><br><span class="line">  <span class="comment">// this way in `inject` we can simply look up injections from direct</span></span><br><span class="line">  <span class="comment">// parent and let the prototype chain do the work.</span></span><br><span class="line">  <span class="keyword">const</span> existing = vm.<span class="property">_provided</span></span><br><span class="line">  <span class="keyword">const</span> parentProvides = vm.<span class="property">$parent</span> &amp;&amp; vm.<span class="property">$parent</span>.<span class="property">_provided</span></span><br><span class="line">  <span class="keyword">if</span> (parentProvides === existing) &#123;</span><br><span class="line">    <span class="keyword">return</span> (vm.<span class="property">_provided</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(parentProvides))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> existing</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="stateMixin"><a href="#stateMixin" class="headerlink" title="stateMixin"></a>stateMixin</h2><p> <code>stateMixin</code> 函数用于扩展 Vue 组件原型方法，添加了与响应式数据相关的属性和方法（<code>$data, $props, $set, $del、$watch</code>）。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stateMixin</span>(<span class="params"><span class="title class_">Vue</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="comment">// flow somehow has problems with directly declared definition object</span></span><br><span class="line">  <span class="comment">// when using Object.defineProperty, so we have to procedurally build up</span></span><br><span class="line">  <span class="comment">// the object here.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dataDef</span>: <span class="built_in">any</span> = &#123;&#125;</span><br><span class="line">  dataDef.<span class="property">get</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_data</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">propsDef</span>: <span class="built_in">any</span> = &#123;&#125;</span><br><span class="line">  propsDef.<span class="property">get</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_props</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// 在开发环境下阻止直接替换 $data 或修改 $props</span></span><br><span class="line">    dataDef.<span class="property">set</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Avoid replacing instance root $data. &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Use nested data properties instead.&#x27;</span>,</span><br><span class="line">        <span class="variable language_">this</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    propsDef.<span class="property">set</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`$props is readonly.`</span>, <span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// dataDef 的 get 方法返回 Vue 实例内部的 _data 对象（组件的数据对象）。</span></span><br><span class="line">  <span class="comment">// propsDef 的 get 方法返回内部的 _props 对象（组件的 props 数据）。</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$data&#x27;</span>, dataDef)</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$props&#x27;</span>, propsDef)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$set</span> = set</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$delete</span> = del</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watch</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">expOrFn</span>: <span class="built_in">string</span> | (() =&gt; <span class="built_in">any</span>),</span></span><br><span class="line"><span class="params">    <span class="attr">cb</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">options</span>?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;</span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(cb)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createWatcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    &#125;</span><br><span class="line">    options = options || &#123;&#125;</span><br><span class="line">    options.<span class="property">user</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">immediate</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> info = <span class="string">`callback for immediate watcher &quot;<span class="subst">$&#123;watcher.expression&#125;</span>&quot;`</span></span><br><span class="line">      <span class="title function_">pushTarget</span>()</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(cb, vm, [watcher.<span class="property">value</span>], vm, info)</span><br><span class="line">      <span class="title function_">popTarget</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unwatchFn</span>(<span class="params"></span>) &#123;</span><br><span class="line">      watcher.<span class="title function_">teardown</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="set"><a href="#set" class="headerlink" title="$set"></a>$set</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向响应式对象添加新属性，确保新属性也是响应式的</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">target</span>: <span class="built_in">any</span>[] | <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">key</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">val</span>: <span class="built_in">any</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="comment">// 在开发模式下，若 target 是 undefined、null 或原始类型（如 number、string），警告无法添加响应式属性。</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; (<span class="title function_">isUndef</span>(target) || <span class="title function_">isPrimitive</span>(target))) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Cannot set reactive property on undefined, null, or primitive value: <span class="subst">$&#123;target&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若 target 是只读对象（如通过 Object.freeze 处理），警告并直接返回。</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isReadonly</span>(target)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp; <span class="title function_">warn</span>(<span class="string">`Set operation on key &quot;<span class="subst">$&#123;key&#125;</span>&quot; failed: target is readonly.`</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// __ob__属性，这是Vue内部用来标记响应式对象的Observer实例</span></span><br><span class="line">  <span class="keyword">const</span> ob = (target <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__ob__</span></span><br><span class="line">  <span class="comment">//  若 target 是数组且 key 是合法索引（非负整数）：</span></span><br><span class="line">  <span class="comment">// 调整数组长度以确保索引有效。</span></span><br><span class="line">  <span class="comment">// 通过 splice 方法修改数组（Vue 重写了数组的 splice 方法，能触发视图更新）。</span></span><br><span class="line">  <span class="comment">// 如果是服务端渲染的 mock 模式且非浅层观察（shallow: false），对新值 val 进行响应式处理。</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="property">length</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(target.<span class="property">length</span>, key)</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>, val)</span><br><span class="line">    <span class="comment">// when mocking for SSR, array methods are not hijacked</span></span><br><span class="line">    <span class="keyword">if</span> (ob &amp;&amp; !ob.<span class="property">shallow</span> &amp;&amp; ob.<span class="property">mock</span>) &#123;</span><br><span class="line">      <span class="title function_">observe</span>(val, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若 key 是 target 自身属性（非继承自原型链），直接赋值。此时属性已经是响应式的，赋值会触发 setter 并通知依赖更新。</span></span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> target &amp;&amp; !(key <span class="keyword">in</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>)) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 防止运行时向 Vue 实例或根数据对象（$data）动态添加属性</span></span><br><span class="line">  <span class="keyword">if</span> ((target <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_isVue</span> || (ob &amp;&amp; ob.<span class="property">vmCount</span>)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Avoid adding reactive properties to a Vue instance or its root $data &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;at runtime - declare it upfront in the data option.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 若 target 没有关联的 Observer 实例（__ob__），说明它不是响应式对象，直接赋值无需处理依赖。</span></span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 调用 defineReactive，将 key 转换为 getter/setter，并递归观察 val（除非 shallow: true）</span></span><br><span class="line">  <span class="title function_">defineReactive</span>(ob.<span class="property">value</span>, key, val, <span class="literal">undefined</span>, ob.<span class="property">shallow</span>, ob.<span class="property">mock</span>)</span><br><span class="line">  <span class="comment">// 在开发环境下，携带操作类型（ADD）、目标对象、键和新值信息，便于调试。</span></span><br><span class="line">  <span class="comment">// 在生产环境下，直接调用 ob.dep.notify()，通知所有依赖该对象的 Watcher 更新视图。</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">TriggerOpTypes</span>.<span class="property">ADD</span>,</span><br><span class="line">      <span class="attr">target</span>: target,</span><br><span class="line">      key,</span><br><span class="line">      <span class="attr">newValue</span>: val,</span><br><span class="line">      <span class="attr">oldValue</span>: <span class="literal">undefined</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="del"><a href="#del" class="headerlink" title="$del"></a>$del</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除属性并触发视图更新。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">del</span>(<span class="params"><span class="attr">target</span>: <span class="built_in">any</span>[] | <span class="built_in">object</span>, <span class="attr">key</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; (<span class="title function_">isUndef</span>(target) || <span class="title function_">isPrimitive</span>(target))) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Cannot delete reactive property on undefined, null, or primitive value: <span class="subst">$&#123;target&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (target <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__ob__</span> <span class="comment">// 获取与 target 关联的 Observer 对象（通过 __ob__ 属性）</span></span><br><span class="line">  <span class="keyword">if</span> ((target <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_isVue</span> || (ob &amp;&amp; ob.<span class="property">vmCount</span>)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Avoid deleting properties on a Vue instance or its root $data &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;- just set it to null.&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isReadonly</span>(target)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`Delete operation on key &quot;<span class="subst">$&#123;key&#125;</span>&quot; failed: target is readonly.`</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">hasOwn</span>(target, key)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">delete</span> target[key]</span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开发环境下传递操作类型（DELETE）、目标对象和键，辅助调试。</span></span><br><span class="line">    <span class="comment">// 生产环境直接调用 ob.dep.notify()，通知所有 Watcher 更新视图。</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">TriggerOpTypes</span>.<span class="property">DELETE</span>,</span><br><span class="line">      <span class="attr">target</span>: target,</span><br><span class="line">      key</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="watch"><a href="#watch" class="headerlink" title="$watch"></a>$watch</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watch</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">expOrFn</span>: <span class="built_in">string</span> | (() =&gt; <span class="built_in">any</span>), <span class="attr">cb</span>: <span class="built_in">any</span>, <span class="attr">options</span>?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">  <span class="comment">// 若 cb 是对象（如 &#123; handler: fn, deep: true &#125;），调用 createWatcher 解析。</span></span><br><span class="line">  <span class="comment">// createWatcher 会提取 handler 和 options，重新调用 $watch 标准化参数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(cb)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createWatcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">  &#125;</span><br><span class="line">  options = options || &#123;&#125;</span><br><span class="line">  options.<span class="property">user</span> = <span class="literal">true</span> <span class="comment">// 标记该 Watcher 由用户定义（非 Vue 内部生成），用于优化错误堆栈信息，使开发者能清晰定位用户回调中的错误。</span></span><br><span class="line">  <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, expOrFn, cb, options)</span><br><span class="line">  <span class="comment">// 依赖收集：在 Watcher 构造函数中，首次执行 expOrFn（求值过程），触发响应式数据的 getter，将当前 Watcher 添加到数据的依赖列表（Dep）中。</span></span><br><span class="line">  <span class="comment">// 更新触发：当数据变化时，setter 通知依赖列表中的所有 Watcher 执行 update，最终调用回调 cb。</span></span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">immediate</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> info = <span class="string">`callback for immediate watcher &quot;<span class="subst">$&#123;watcher.expression&#125;</span>&quot;`</span></span><br><span class="line">    <span class="title function_">pushTarget</span>()</span><br><span class="line">    <span class="title function_">invokeWithErrorHandling</span>(cb, vm, [watcher.<span class="property">value</span>], vm, info)</span><br><span class="line">    <span class="title function_">popTarget</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unwatchFn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    watcher.<span class="title function_">teardown</span>() <span class="comment">// 遍历 Watcher 的所有依赖（deps），从它们的订阅列表中删除该 Watcher。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="eventsMixin"><a href="#eventsMixin" class="headerlink" title="eventsMixin"></a>eventsMixin</h2><p><code>eventsMixin</code>函数的作用是给Vue的原型添加事件相关的方法，包括<code>$on</code>、<code>$once</code>、<code>$off</code>和<code>$emit</code>。这些方法是Vue事件系统的核心，负责组件间的事件通信。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">eventsMixin</span>(<span class="params"><span class="title class_">Vue</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hookRE = <span class="regexp">/^hook:/</span> <span class="comment">// 正则表达式，用于识别生命周期钩子事件（如 hook:created）</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$on</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">event</span>: <span class="built_in">string</span> | <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="attr">fn</span>: <span class="title class_">Function</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray</span>(event)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = event.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        vm.$on(event[i], fn)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ;(vm.<span class="property">_events</span>[event] || (vm.<span class="property">_events</span>[event] = [])).<span class="title function_">push</span>(fn)</span><br><span class="line">      <span class="comment">// optimize hook:event cost by using a boolean flag marked at registration</span></span><br><span class="line">      <span class="comment">// instead of a hash lookup</span></span><br><span class="line">      <span class="comment">// 若事件名以 hook: 开头（如 hook:mounted），设置 _hasHookEvent = true，避免在生命周期钩子触发时遍历所有事件，提升性能。</span></span><br><span class="line">      <span class="keyword">if</span> (hookRE.<span class="title function_">test</span>(event)) &#123;</span><br><span class="line">        vm.<span class="property">_hasHookEvent</span> = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vm</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 包装函数：创建代理函数 on，在触发时调用 $off 移除自身，确保仅执行一次。</span></span><br><span class="line">  <span class="comment">// 原始函数绑定：通过 on.fn = fn 保留原始回调引用，使 $off(fn) 能正确移除包装函数。</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$once</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">event</span>: <span class="built_in">string</span>, <span class="attr">fn</span>: <span class="title class_">Function</span></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">on</span>(<span class="params"></span>) &#123;</span><br><span class="line">      vm.$off(event, on)</span><br><span class="line">      fn.<span class="title function_">apply</span>(vm, <span class="variable language_">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    on.<span class="property">fn</span> = fn</span><br><span class="line">    vm.$on(event, on)</span><br><span class="line">    <span class="keyword">return</span> vm</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$off</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">event</span>?: <span class="built_in">string</span> | <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="attr">fn</span>?: <span class="title class_">Function</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// 无参数：移除所有事件监听</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">arguments</span>.<span class="property">length</span>) &#123;</span><br><span class="line">      vm.<span class="property">_events</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">return</span> vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 事件名数组：递归移除</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray</span>(event)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = event.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        vm.$off(event[i], fn)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 特定事件处理</span></span><br><span class="line">    <span class="keyword">const</span> cbs = vm.<span class="property">_events</span>[event!]</span><br><span class="line">    <span class="keyword">if</span> (!cbs) &#123;</span><br><span class="line">      <span class="keyword">return</span> vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 无回调函数：清空该事件所有监听器</span></span><br><span class="line">    <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">      vm.<span class="property">_events</span>[event!] = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span> vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 移除特定回调（包括 $once 的包装函数）</span></span><br><span class="line">    <span class="keyword">let</span> cb</span><br><span class="line">    <span class="keyword">let</span> i = cbs.<span class="property">length</span></span><br><span class="line">    <span class="comment">// 采用倒序遍历数组，主要是为了解决正序删除元素导致的索引错位问题，并优化遍历性能</span></span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      cb = cbs[i]</span><br><span class="line">      <span class="keyword">if</span> (cb === fn || cb.<span class="property">fn</span> === fn) &#123; <span class="comment">// 匹配原始函数或包装函数</span></span><br><span class="line">        cbs.<span class="title function_">splice</span>(i, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span> <span class="comment">// 找到匹配项后 break，避免不必要的遍历（即使有多个匹配项，也只删第一个）</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vm</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$emit</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">event</span>: <span class="built_in">string</span></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">// 开发环境：检查驼峰事件名在 DOM 模板中的使用问题</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> lowerCaseEvent = event.<span class="title function_">toLowerCase</span>()</span><br><span class="line">      <span class="keyword">if</span> (lowerCaseEvent !== event &amp;&amp; vm.<span class="property">_events</span>[lowerCaseEvent]) &#123;</span><br><span class="line">        <span class="title function_">tip</span>(</span><br><span class="line">          <span class="string">`Event &quot;<span class="subst">$&#123;lowerCaseEvent&#125;</span>&quot; is emitted in component `</span> +</span><br><span class="line">            <span class="string">`<span class="subst">$&#123;formatComponentName(</span></span></span><br><span class="line"><span class="subst"><span class="string">              vm</span></span></span><br><span class="line"><span class="subst"><span class="string">            )&#125;</span> but the handler is registered for &quot;<span class="subst">$&#123;event&#125;</span>&quot;. `</span> +</span><br><span class="line">            <span class="string">`Note that HTML attributes are case-insensitive and you cannot use `</span> +</span><br><span class="line">            <span class="string">`v-on to listen to camelCase events when using in-DOM templates. `</span> +</span><br><span class="line">            <span class="string">`You should probably use &quot;<span class="subst">$&#123;hyphenate(</span></span></span><br><span class="line"><span class="subst"><span class="string">              event</span></span></span><br><span class="line"><span class="subst"><span class="string">            )&#125;</span>&quot; instead of &quot;<span class="subst">$&#123;event&#125;</span>&quot;.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> cbs = vm.<span class="property">_events</span>[event]</span><br><span class="line">    <span class="keyword">if</span> (cbs) &#123;</span><br><span class="line">      cbs = cbs.<span class="property">length</span> &gt; <span class="number">1</span> ? <span class="title function_">toArray</span>(cbs) : cbs</span><br><span class="line">      <span class="keyword">const</span> args = <span class="title function_">toArray</span>(<span class="variable language_">arguments</span>, <span class="number">1</span>) <span class="comment">// 获取事件参数（除事件名）</span></span><br><span class="line">      <span class="keyword">const</span> info = <span class="string">`event handler for &quot;<span class="subst">$&#123;event&#125;</span>&quot;`</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = cbs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="title function_">invokeWithErrorHandling</span>(cbs[i], vm, args, vm, info)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vm</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="为什么-off使用的是倒序遍历"><a href="#为什么-off使用的是倒序遍历" class="headerlink" title="为什么$off使用的是倒序遍历"></a>为什么$off使用的是倒序遍历</h3><h4 id="避免索引错位问题"><a href="#避免索引错位问题" class="headerlink" title="避免索引错位问题"></a><strong>避免索引错位问题</strong></h4><p>假设有一个事件监听器数组 <code>[A, B, C, D]</code>，需要移除回调 <code>B</code>。</p>
<ul>
<li><strong>正序遍历</strong>（从前往后）：<ol>
<li>当遍历到索引 <code>1</code>（元素 <code>B</code>）时，调用 <code>splice(1, 1)</code> 删除 <code>B</code>，数组变为 <code>[A, C, D]</code>。</li>
<li>下一轮循环索引递增到 <code>2</code>，此时对应元素 <code>D</code>，**跳过了原索引 <code>2</code> 处的 <code>C</code>**，导致 <code>C</code> 未被检查。</li>
</ol>
</li>
<li><strong>倒序遍历</strong>（从后往前）：<ol>
<li>初始索引 <code>3</code>（元素 <code>D</code>）→ 未匹配。</li>
<li>索引 <code>2</code>（元素 <code>C</code>）→ 未匹配。</li>
<li>索引 <code>1</code>（元素 <code>B</code>）→ 匹配后删除，数组变为 <code>[A, C, D]</code>。</li>
<li>下一轮索引递减到 <code>0</code>（元素 <code>A</code>）→ 未匹配。</li>
<li>所有元素均被检查，无遗漏。</li>
</ol>
</li>
</ul>
<p>倒序遍历的索引变化与数组修改方向相反，删除元素不会影响未遍历的索引，确保所有回调都被正确处理。</p>
<hr>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a><strong>性能优化</strong></h4><ul>
<li><strong>正序删除元素</strong>：每次调用 <code>splice</code> 删除元素后，后续元素的索引会前移，导致后续遍历需要重新计算索引位置。</li>
<li><strong>倒序删除元素</strong>：从后往前删除时，已处理过的元素位于数组尾部，删除操作不会影响前面未遍历的索引，减少索引计算开销。</li>
</ul>
<p>虽然 Vue 的 <code>$off</code> 在找到匹配回调后立即 <code>break</code>（只删一个），但倒序仍是更稳健的选择：</p>
<ol>
<li><strong>代码一致性</strong>：若未来需要支持删除多个匹配项（如没有 <code>break</code>），倒序能直接避免索引错位问题。</li>
<li><strong>减少副作用</strong>：即使只删一个元素，倒序也无需额外处理索引偏移，逻辑更简单。</li>
</ol>
<h2 id="lifecycleMixin"><a href="#lifecycleMixin" class="headerlink" title="lifecycleMixin"></a>lifecycleMixin</h2><p>在Vue的原型上添加了三个方法：<code>_update</code>、<code>$forceUpdate</code>和<code>$destroy</code></p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">lifecycleMixin</span>(<span class="params"><span class="title class_">Vue</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 负责组件的初次渲染和更新，通过 __patch__ 对比新旧 VNode 生成或更新 DOM。</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">vnode</span>: <span class="title class_">VNode</span>, <span class="attr">hydrating</span>?: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> prevEl = vm.<span class="property">$el</span></span><br><span class="line">    <span class="keyword">const</span> prevVnode = vm.<span class="property">_vnode</span></span><br><span class="line">    <span class="keyword">const</span> restoreActiveInstance = <span class="title function_">setActiveInstance</span>(vm) <span class="comment">// 设置当前激活的 Vue 实例</span></span><br><span class="line">    vm.<span class="property">_vnode</span> = vnode</span><br><span class="line">    <span class="comment">// Vue.prototype.__patch__ is injected in entry points</span></span><br><span class="line">    <span class="comment">// based on the rendering backend used.</span></span><br><span class="line">    <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">      <span class="comment">// 初次渲染：用新 VNode 生成 DOM</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 更新渲染：对比新旧 VNode，更新 DOM</span></span><br><span class="line">      vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">restoreActiveInstance</span>()</span><br><span class="line">    <span class="comment">// update __vue__ reference</span></span><br><span class="line">    <span class="keyword">if</span> (prevEl) &#123; <span class="comment">// 解除旧元素的实例引用</span></span><br><span class="line">      prevEl.<span class="property">__vue__</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$el</span>) &#123; <span class="comment">// 新元素记录当前实例</span></span><br><span class="line">      vm.<span class="property">$el</span>.<span class="property">__vue__</span> = vm</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if parent is an HOC, update its $el as well</span></span><br><span class="line">    <span class="comment">// 处理高阶组件（HOC）的父级 $el 更新</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">wrapper</span>: <span class="title class_">Component</span> | <span class="literal">undefined</span> = vm</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      wrapper &amp;&amp;</span><br><span class="line">      wrapper.<span class="property">$vnode</span> &amp;&amp;</span><br><span class="line">      wrapper.<span class="property">$parent</span> &amp;&amp;</span><br><span class="line">      wrapper.<span class="property">$vnode</span> === wrapper.<span class="property">$parent</span>.<span class="property">_vnode</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      wrapper.<span class="property">$parent</span>.<span class="property">$el</span> = wrapper.<span class="property">$el</span> <span class="comment">// 父级 $el 指向子组件的根元素</span></span><br><span class="line">      wrapper = wrapper.<span class="property">$parent</span> <span class="comment">// 向上遍历父级链</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// updated hook is called by the scheduler to ensure that children are</span></span><br><span class="line">    <span class="comment">// updated in a parent&#x27;s updated hook.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$forceUpdate</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">_watcher</span>) &#123;</span><br><span class="line">      vm.<span class="property">_watcher</span>.<span class="title function_">update</span>() <span class="comment">// 强制触发渲染 Watcher 更新</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$destroy</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">_isBeingDestroyed</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeDestroy&#x27;</span>)</span><br><span class="line">    vm.<span class="property">_isBeingDestroyed</span> = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// remove self from parent</span></span><br><span class="line">    <span class="keyword">const</span> parent = vm.<span class="property">$parent</span></span><br><span class="line">    <span class="comment">// 从父组件中移除自身（非抽象组件）</span></span><br><span class="line">    <span class="keyword">if</span> (parent &amp;&amp; !parent.<span class="property">_isBeingDestroyed</span> &amp;&amp; !vm.<span class="property">$options</span>.<span class="property">abstract</span>) &#123;</span><br><span class="line">      <span class="title function_">remove</span>(parent.<span class="property">$children</span>, vm) <span class="comment">// 从父级 $children 中删除</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// teardown scope. this includes both the render watcher and other</span></span><br><span class="line">    <span class="comment">// watchers created</span></span><br><span class="line">    <span class="comment">// 停止所有作用域（渲染 Watcher 和其他 Watcher）</span></span><br><span class="line">    vm.<span class="property">_scope</span>.<span class="title function_">stop</span>()</span><br><span class="line">    <span class="comment">// 减少 data.__ob__.vmCount（Observer 的实例计数）</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">_data</span>.<span class="property">__ob__</span>) &#123;</span><br><span class="line">      vm.<span class="property">_data</span>.<span class="property">__ob__</span>.<span class="property">vmCount</span>--</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// call the last hook...</span></span><br><span class="line">    vm.<span class="property">_isDestroyed</span> = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// invoke destroy hooks on current rendered tree</span></span><br><span class="line">    <span class="comment">// 销毁 DOM，触发子组件的销毁钩子</span></span><br><span class="line">    vm.<span class="title function_">__patch__</span>(vm.<span class="property">_vnode</span>, <span class="literal">null</span>)</span><br><span class="line">    <span class="comment">// fire destroyed hook</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;destroyed&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    vm.$off() <span class="comment">// 移除所有事件监听器</span></span><br><span class="line">    <span class="comment">// 清除 DOM 元素的 __vue__ 引用</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$el</span>) &#123;</span><br><span class="line">      vm.<span class="property">$el</span>.<span class="property">__vue__</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// release circular reference (#6759)</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$vnode</span>) &#123;</span><br><span class="line">      vm.<span class="property">$vnode</span>.<span class="property">parent</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><p>对比新旧 VNode 生成或更新 DOM。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode)) <span class="title function_">invokeDestroyHook</span>(oldVnode)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isInitialPatch = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">insertedVnodeQueue</span>: <span class="built_in">any</span>[] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">      <span class="comment">// empty mount (likely as component), create new root element</span></span><br><span class="line">      isInitialPatch = <span class="literal">true</span></span><br><span class="line">      <span class="title function_">createElm</span>(vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>)</span><br><span class="line">      <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">        <span class="comment">// patch existing root node</span></span><br><span class="line">        <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isRealElement) &#123;</span><br><span class="line">          <span class="comment">// mounting to a real element</span></span><br><span class="line">          <span class="comment">// check if this is server-rendered content and if we can perform</span></span><br><span class="line">          <span class="comment">// a successful hydration.</span></span><br><span class="line">          <span class="keyword">if</span> (oldVnode.<span class="property">nodeType</span> === <span class="number">1</span> &amp;&amp; oldVnode.<span class="title function_">hasAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)) &#123;</span><br><span class="line">            oldVnode.<span class="title function_">removeAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)</span><br><span class="line">            hydrating = <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isTrue</span>(hydrating)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">              <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="literal">true</span>)</span><br><span class="line">              <span class="keyword">return</span> oldVnode</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">              <span class="title function_">warn</span>(</span><br><span class="line">                <span class="string">&#x27;The client-side rendered virtual DOM tree is not matching &#x27;</span> +</span><br><span class="line">                  <span class="string">&#x27;server-rendered content. This is likely caused by incorrect &#x27;</span> +</span><br><span class="line">                  <span class="string">&#x27;HTML markup, for example nesting block-level elements inside &#x27;</span> +</span><br><span class="line">                  <span class="string">&#x27;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#x27;</span> +</span><br><span class="line">                  <span class="string">&#x27;full client-side render.&#x27;</span></span><br><span class="line">              )</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// either not server-rendered, or hydration failed.</span></span><br><span class="line">          <span class="comment">// create an empty node and replace it</span></span><br><span class="line">          oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// replacing existing element</span></span><br><span class="line">        <span class="keyword">const</span> oldElm = oldVnode.<span class="property">elm</span></span><br><span class="line">        <span class="keyword">const</span> parentElm = nodeOps.<span class="title function_">parentNode</span>(oldElm)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create new node</span></span><br><span class="line">        <span class="title function_">createElm</span>(</span><br><span class="line">          vnode,</span><br><span class="line">          insertedVnodeQueue,</span><br><span class="line">          <span class="comment">// extremely rare edge case: do not insert if old element is in a</span></span><br><span class="line">          <span class="comment">// leaving transition. Only happens when combining transition +</span></span><br><span class="line">          <span class="comment">// keep-alive + HOCs. (#4590)</span></span><br><span class="line">          oldElm.<span class="property">_leaveCb</span> ? <span class="literal">null</span> : parentElm,</span><br><span class="line">          nodeOps.<span class="title function_">nextSibling</span>(oldElm)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update parent placeholder node element, recursively</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">parent</span>)) &#123;</span><br><span class="line">          <span class="keyword">let</span> ancestor = vnode.<span class="property">parent</span></span><br><span class="line">          <span class="keyword">const</span> patchable = <span class="title function_">isPatchable</span>(vnode)</span><br><span class="line">          <span class="keyword">while</span> (ancestor) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.<span class="property">destroy</span>.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">              cbs.<span class="property">destroy</span>[i](ancestor)</span><br><span class="line">            &#125;</span><br><span class="line">            ancestor.<span class="property">elm</span> = vnode.<span class="property">elm</span></span><br><span class="line">            <span class="keyword">if</span> (patchable) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.<span class="property">create</span>.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">                cbs.<span class="property">create</span>[i](emptyNode, ancestor)</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// #6513</span></span><br><span class="line">              <span class="comment">// invoke insert hooks that may have been merged by create hooks.</span></span><br><span class="line">              <span class="comment">// e.g. for directives that uses the &quot;inserted&quot; hook.</span></span><br><span class="line">              <span class="keyword">const</span> insert = ancestor.<span class="property">data</span>.<span class="property">hook</span>.<span class="property">insert</span></span><br><span class="line">              <span class="keyword">if</span> (insert.<span class="property">merged</span>) &#123;</span><br><span class="line">                <span class="comment">// start at index 1 to avoid re-invoking component mounted hook</span></span><br><span class="line">                <span class="comment">// clone insert hooks to avoid being mutated during iteration.</span></span><br><span class="line">                <span class="comment">// e.g. for customed directives under transition group.</span></span><br><span class="line">                <span class="keyword">const</span> cloned = insert.<span class="property">fns</span>.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cloned.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                  cloned[i]()</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">registerRef</span>(ancestor)</span><br><span class="line">            &#125;</span><br><span class="line">            ancestor = ancestor.<span class="property">parent</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// destroy old node</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isDef</span>(parentElm)) &#123;</span><br><span class="line">          <span class="title function_">removeVnodes</span>([oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">tag</span>)) &#123;</span><br><span class="line">          <span class="title function_">invokeDestroyHook</span>(oldVnode)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch)</span><br><span class="line">    <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="renderMixin"><a href="#renderMixin" class="headerlink" title="renderMixin"></a>renderMixin</h2><p>在Vue的原型上添加与渲染相关的方法，比如<code>$nextTick</code>和<code>_render</code></p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderMixin</span>(<span class="params"><span class="title class_">Vue</span>: <span class="keyword">typeof</span> <span class="title class_">Component</span></span>) &#123;</span><br><span class="line">  <span class="comment">// install runtime convenience helpers</span></span><br><span class="line">  <span class="title function_">installRenderHelpers</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>) <span class="comment">// 作用：向 Vue.prototype 注入渲染过程中使用的工具方法</span></span><br><span class="line">  </span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">fn</span>: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">nextTick</span>(fn, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_parentVnode &amp;&amp; vm.<span class="property">_isMounted</span>) &#123;</span><br><span class="line">      vm.<span class="property">$scopedSlots</span> = <span class="title function_">normalizeScopedSlots</span>(</span><br><span class="line">        vm.<span class="property">$parent</span>!,</span><br><span class="line">        _parentVnode.<span class="property">data</span>!.<span class="property">scopedSlots</span>,</span><br><span class="line">        vm.<span class="property">$slots</span>,</span><br><span class="line">        vm.<span class="property">$scopedSlots</span></span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_slotsProxy</span>) &#123;</span><br><span class="line">        <span class="title function_">syncSetupSlots</span>(vm.<span class="property">_slotsProxy</span>, vm.<span class="property">$scopedSlots</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set parent vnode. this allows render functions to have access</span></span><br><span class="line">    <span class="comment">// to the data on the placeholder node.</span></span><br><span class="line">    vm.<span class="property">$vnode</span> = _parentVnode!</span><br><span class="line">    <span class="comment">// render self</span></span><br><span class="line">    <span class="keyword">const</span> prevInst = currentInstance</span><br><span class="line">    <span class="keyword">const</span> prevRenderInst = currentRenderingInstance</span><br><span class="line">    <span class="keyword">let</span> vnode</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">setCurrentInstance</span>(vm)</span><br><span class="line">      currentRenderingInstance = vm</span><br><span class="line">      vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(e, vm, <span class="string">`render`</span>)</span><br><span class="line">      <span class="comment">// return error render result,</span></span><br><span class="line">      <span class="comment">// or previous vnode to prevent render error causing blank component</span></span><br><span class="line">      <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; vm.<span class="property">$options</span>.<span class="property">renderError</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          vnode = vm.<span class="property">$options</span>.<span class="property">renderError</span>.<span class="title function_">call</span>(</span><br><span class="line">            vm.<span class="property">_renderProxy</span>,</span><br><span class="line">            vm.<span class="property">$createElement</span>,</span><br><span class="line">            e</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">          <span class="title function_">handleError</span>(e, vm, <span class="string">`renderError`</span>)</span><br><span class="line">          vnode = vm.<span class="property">_vnode</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vnode = vm.<span class="property">_vnode</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      currentRenderingInstance = prevRenderInst</span><br><span class="line">      <span class="title function_">setCurrentInstance</span>(prevInst)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if the returned array contains only a single node, allow it</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray</span>(vnode) &amp;&amp; vnode.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">      vnode = vnode[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// return empty vnode in case the render function errored out</span></span><br><span class="line">    <span class="keyword">if</span> (!(vnode <span class="keyword">instanceof</span> <span class="title class_">VNode</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;Multiple root nodes returned from render function. Render function &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;should return a single root node.&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      vnode = <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// set parent</span></span><br><span class="line">    vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="工具方法"><a href="#工具方法" class="headerlink" title="工具方法"></a>工具方法</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">installRenderHelpers</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">installRenderHelpers</span>(<span class="params"><span class="attr">target</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  target.<span class="property">_o</span> = markOnce</span><br><span class="line">  target.<span class="property">_n</span> = toNumber</span><br><span class="line">  target.<span class="property">_s</span> = toString</span><br><span class="line">  target.<span class="property">_l</span> = renderList</span><br><span class="line">  target.<span class="property">_t</span> = renderSlot</span><br><span class="line">  target.<span class="property">_q</span> = looseEqual</span><br><span class="line">  target.<span class="property">_i</span> = looseIndexOf</span><br><span class="line">  target.<span class="property">_m</span> = renderStatic</span><br><span class="line">  target.<span class="property">_f</span> = resolveFilter</span><br><span class="line">  target.<span class="property">_k</span> = checkKeyCodes</span><br><span class="line">  target.<span class="property">_b</span> = bindObjectProps</span><br><span class="line">  target.<span class="property">_v</span> = createTextVNode</span><br><span class="line">  target.<span class="property">_e</span> = createEmptyVNode</span><br><span class="line">  target.<span class="property">_u</span> = resolveScopedSlots</span><br><span class="line">  target.<span class="property">_g</span> = bindObjectListeners</span><br><span class="line">  target.<span class="property">_d</span> = bindDynamicKeys</span><br><span class="line">  target.<span class="property">_p</span> = prependModifier</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="markOnce"><a href="#markOnce" class="headerlink" title="markOnce"></a>markOnce</h4><p>用于处理 <code>v-once</code> 指令的运行时辅助函数。它的核心作用是将虚拟节点标记为静态节点，确保它们只渲染一次。</p>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for v-once.</span></span><br><span class="line"><span class="comment"> * Effectively it means marking the node as static with a unique key.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">markOnce</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">tree</span>: <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">key</span>: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">markStatic</span>(tree, <span class="string">`__once__<span class="subst">$&#123;index&#125;</span><span class="subst">$&#123;key ? <span class="string">`_<span class="subst">$&#123;key&#125;</span>`</span> : <span class="string">``</span>&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">return</span> tree</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 递归标记节点及其子节点为静态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">markStatic</span>(<span class="params"><span class="attr">tree</span>: <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;, <span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">isOnce</span>: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(tree)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tree.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tree[i] &amp;&amp; <span class="keyword">typeof</span> tree[i] !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">markStaticNode</span>(tree[i], <span class="string">`<span class="subst">$&#123;key&#125;</span>_<span class="subst">$&#123;i&#125;</span>`</span>, isOnce)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">markStaticNode</span>(tree, key, isOnce)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">markStaticNode</span>(<span class="params">node, key, isOnce</span>) &#123;</span><br><span class="line">  node.<span class="property">isStatic</span> = <span class="literal">true</span> <span class="comment">// 标记为静态节点</span></span><br><span class="line">  node.<span class="property">key</span> = key <span class="comment">// 设置唯一标识符</span></span><br><span class="line">  node.<span class="property">isOnce</span> = isOnce <span class="comment">// 标记是否为一次性节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="toString-toNumber"><a href="#toString-toNumber" class="headerlink" title="toString&#x2F;toNumber"></a>toString&#x2F;toNumber</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert a value to a string that is actually rendered.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toString</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">any</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> val == <span class="literal">null</span></span><br><span class="line">    ? <span class="string">&#x27;&#x27;</span></span><br><span class="line">    : <span class="title class_">Array</span>.<span class="title function_">isArray</span>(val) || (<span class="title function_">isPlainObject</span>(val) &amp;&amp; val.<span class="property">toString</span> === _toString)</span><br><span class="line">    ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(val, replacer, <span class="number">2</span>)</span><br><span class="line">    : <span class="title class_">String</span>(val)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replacer</span>(<span class="params"><span class="attr">_key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="comment">// avoid circular deps from v3</span></span><br><span class="line">  <span class="keyword">if</span> (val &amp;&amp; val.<span class="property">__v_isRef</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> val.<span class="property">value</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert an input value to a number for persistence.</span></span><br><span class="line"><span class="comment"> * If the conversion fails, return original string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toNumber</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">string</span></span>): <span class="built_in">number</span> | <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> n = <span class="built_in">parseFloat</span>(val)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">isNaN</span>(n) ? val : n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="renderList"><a href="#renderList" class="headerlink" title="renderList"></a>renderList</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for rendering v-for lists.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderList</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">val</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">render</span>: (val: <span class="built_in">any</span>, keyOrIndex: <span class="built_in">string</span> | <span class="built_in">number</span>, index?: <span class="built_in">number</span>) =&gt; <span class="title class_">VNode</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">ret</span>: <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; | <span class="literal">null</span> = <span class="literal">null</span>,</span><br><span class="line">    i,</span><br><span class="line">    l,</span><br><span class="line">    keys,</span><br><span class="line">    key</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(val) || <span class="keyword">typeof</span> val === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="title class_">Array</span>(val.<span class="property">length</span>)</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, l = val.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      ret[i] = <span class="title function_">render</span>(val[i], i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="title class_">Array</span>(val)</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; val; i++) &#123;</span><br><span class="line">      ret[i] = <span class="title function_">render</span>(i + <span class="number">1</span>, i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isObject</span>(val)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasSymbol &amp;&amp; val[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]) &#123;</span><br><span class="line">      ret = []</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">iterator</span>: <span class="title class_">Iterator</span>&lt;<span class="built_in">any</span>&gt; = val[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]()</span><br><span class="line">      <span class="keyword">let</span> result = iterator.<span class="title function_">next</span>()</span><br><span class="line">      <span class="keyword">while</span> (!result.<span class="property">done</span>) &#123;</span><br><span class="line">        ret.<span class="title function_">push</span>(<span class="title function_">render</span>(result.<span class="property">value</span>, ret.<span class="property">length</span>))</span><br><span class="line">        result = iterator.<span class="title function_">next</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(val)</span><br><span class="line">      ret = <span class="keyword">new</span> <span class="title class_">Array</span>(keys.<span class="property">length</span>)</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>, l = keys.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        key = keys[i]</span><br><span class="line">        ret[i] = <span class="title function_">render</span>(val[key], key, i)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isDef</span>(ret)) &#123;</span><br><span class="line">    ret = []</span><br><span class="line">  &#125;</span><br><span class="line">  ;(ret <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_isVList</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="renderSlot"><a href="#renderSlot" class="headerlink" title="renderSlot"></a>renderSlot</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for rendering &lt;slot&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderSlot</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">name</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">fallbackRender</span>: ((() =&gt; <span class="built_in">Array</span>&lt;VNode&gt;) | <span class="built_in">Array</span>&lt;VNode&gt;) | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">props</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">bindObject</span>: <span class="built_in">object</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> scopedSlotFn = <span class="variable language_">this</span>.<span class="property">$scopedSlots</span>[name]</span><br><span class="line">  <span class="keyword">let</span> nodes</span><br><span class="line">  <span class="keyword">if</span> (scopedSlotFn) &#123;</span><br><span class="line">    <span class="comment">// scoped slot</span></span><br><span class="line">    props = props || &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (bindObject) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; !<span class="title function_">isObject</span>(bindObject)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">&#x27;slot v-bind without argument expects an Object&#x27;</span>, <span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      props = <span class="title function_">extend</span>(<span class="title function_">extend</span>(&#123;&#125;, bindObject), props)</span><br><span class="line">    &#125;</span><br><span class="line">    nodes =</span><br><span class="line">      <span class="title function_">scopedSlotFn</span>(props) ||</span><br><span class="line">      (<span class="title function_">isFunction</span>(fallbackRender) ? <span class="title function_">fallbackRender</span>() : fallbackRender)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nodes =</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$slots</span>[name] ||</span><br><span class="line">      (<span class="title function_">isFunction</span>(fallbackRender) ? <span class="title function_">fallbackRender</span>() : fallbackRender)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> target = props &amp;&amp; props.<span class="property">slot</span></span><br><span class="line">  <span class="keyword">if</span> (target) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.$createElement(<span class="string">&#x27;template&#x27;</span>, &#123; <span class="attr">slot</span>: target &#125;, nodes)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nodes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="looseEqual"><a href="#looseEqual" class="headerlink" title="looseEqual"></a>looseEqual</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if two values are loosely equal - that is,</span></span><br><span class="line"><span class="comment"> * if they are plain objects, do they have the same shape?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">looseEqual</span>(<span class="params"><span class="attr">a</span>: <span class="built_in">any</span>, <span class="attr">b</span>: <span class="built_in">any</span></span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (a === b) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  <span class="keyword">const</span> isObjectA = <span class="title function_">isObject</span>(a)</span><br><span class="line">  <span class="keyword">const</span> isObjectB = <span class="title function_">isObject</span>(b)</span><br><span class="line">  <span class="keyword">if</span> (isObjectA &amp;&amp; isObjectB) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> isArrayA = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(a)</span><br><span class="line">      <span class="keyword">const</span> isArrayB = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(b)</span><br><span class="line">      <span class="keyword">if</span> (isArrayA &amp;&amp; isArrayB) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          a.<span class="property">length</span> === b.<span class="property">length</span> &amp;&amp;</span><br><span class="line">          a.<span class="title function_">every</span>(<span class="function">(<span class="params"><span class="attr">e</span>: <span class="built_in">any</span>, <span class="attr">i</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">looseEqual</span>(e, b[i])</span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a <span class="keyword">instanceof</span> <span class="title class_">Date</span> &amp;&amp; b <span class="keyword">instanceof</span> <span class="title class_">Date</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> a.<span class="title function_">getTime</span>() === b.<span class="title function_">getTime</span>()</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isArrayA &amp;&amp; !isArrayB) &#123;</span><br><span class="line">        <span class="keyword">const</span> keysA = <span class="title class_">Object</span>.<span class="title function_">keys</span>(a)</span><br><span class="line">        <span class="keyword">const</span> keysB = <span class="title class_">Object</span>.<span class="title function_">keys</span>(b)</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          keysA.<span class="property">length</span> === keysB.<span class="property">length</span> &amp;&amp;</span><br><span class="line">          keysA.<span class="title function_">every</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">looseEqual</span>(a[key], b[key])</span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isObjectA &amp;&amp; !isObjectB) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">String</span>(a) === <span class="title class_">String</span>(b)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="looseIndexOf"><a href="#looseIndexOf" class="headerlink" title="looseIndexOf"></a>looseIndexOf</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the first index at which a loosely equal value can be</span></span><br><span class="line"><span class="comment"> * found in the array (if value is a plain object, the array must</span></span><br><span class="line"><span class="comment"> * contain an object of the same shape), or -1 if it is not present.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">looseIndexOf</span>(<span class="params"><span class="attr">arr</span>: <span class="title class_">Array</span>&lt;<span class="built_in">unknown</span>&gt;, <span class="attr">val</span>: <span class="built_in">unknown</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">looseEqual</span>(arr[i], val)) <span class="keyword">return</span> i</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="renderStatic"><a href="#renderStatic" class="headerlink" title="renderStatic"></a>renderStatic</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for rendering static trees.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderStatic</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">isInFor</span>: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> cached = <span class="variable language_">this</span>.<span class="property">_staticTrees</span> || (<span class="variable language_">this</span>.<span class="property">_staticTrees</span> = [])</span><br><span class="line">  <span class="keyword">let</span> tree = cached[index]</span><br><span class="line">  <span class="comment">// if has already-rendered static tree and not inside v-for,</span></span><br><span class="line">  <span class="comment">// we can reuse the same tree.</span></span><br><span class="line">  <span class="keyword">if</span> (tree &amp;&amp; !isInFor) &#123;</span><br><span class="line">    <span class="keyword">return</span> tree</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// otherwise, render a fresh tree.</span></span><br><span class="line">  tree = cached[index] = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">staticRenderFns</span>[index].<span class="title function_">call</span>(</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_renderProxy</span>,</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_c</span>,</span><br><span class="line">    <span class="variable language_">this</span> <span class="comment">// for render fns generated for functional component templates</span></span><br><span class="line">  )</span><br><span class="line">  <span class="title function_">markStatic</span>(tree, <span class="string">`__static__<span class="subst">$&#123;index&#125;</span>`</span>, <span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">return</span> tree</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="resolveFilter"><a href="#resolveFilter" class="headerlink" title="resolveFilter"></a>resolveFilter</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for resolving filters</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveFilter</span>(<span class="params"><span class="attr">id</span>: <span class="built_in">string</span></span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">resolveAsset</span>(<span class="variable language_">this</span>.<span class="property">$options</span>, <span class="string">&#x27;filters&#x27;</span>, id, <span class="literal">true</span>) || identity</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Resolve an asset.</span></span><br><span class="line"><span class="comment"> * This function is used because child instances need access</span></span><br><span class="line"><span class="comment"> * to assets defined in its ancestor chain.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveAsset</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">type</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">id</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">warnMissing</span>?: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> id !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> assets = options[<span class="keyword">type</span>]</span><br><span class="line">  <span class="comment">// check local registration variations first</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(assets, id)) <span class="keyword">return</span> assets[id]</span><br><span class="line">  <span class="keyword">const</span> camelizedId = <span class="title function_">camelize</span>(id)</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(assets, camelizedId)) <span class="keyword">return</span> assets[camelizedId]</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">PascalCaseId</span> = <span class="title function_">capitalize</span>(camelizedId)</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(assets, <span class="title class_">PascalCaseId</span>)) <span class="keyword">return</span> assets[<span class="title class_">PascalCaseId</span>]</span><br><span class="line">  <span class="comment">// fallback to prototype chain</span></span><br><span class="line">  <span class="keyword">const</span> res = assets[id] || assets[camelizedId] || assets[<span class="title class_">PascalCaseId</span>]</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; warnMissing &amp;&amp; !res) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Failed to resolve &#x27;</span> + <span class="keyword">type</span>.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) + <span class="string">&#x27;: &#x27;</span> + id)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check whether an object has the property.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> hasOwnProperty = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">hasOwn</span>(<span class="params"><span class="attr">obj</span>: <span class="title class_">Object</span> | <span class="title class_">Array</span>&lt;<span class="built_in">any</span>&gt;, <span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> hasOwnProperty.<span class="title function_">call</span>(obj, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="checkKeyCodes"><a href="#checkKeyCodes" class="headerlink" title="checkKeyCodes"></a>checkKeyCodes</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for checking keyCodes from config.</span></span><br><span class="line"><span class="comment"> * exposed as Vue.prototype._k</span></span><br><span class="line"><span class="comment"> * passing in eventKeyName as last argument separately for backwards compat</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">checkKeyCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">eventKeyCode</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">key</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">builtInKeyCode</span>?: <span class="built_in">number</span> | <span class="title class_">Array</span>&lt;<span class="built_in">number</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">eventKeyName</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">builtInKeyName</span>?: <span class="built_in">string</span> | <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">boolean</span> | <span class="literal">null</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> mappedKeyCode = config.<span class="property">keyCodes</span>[key] || builtInKeyCode</span><br><span class="line">  <span class="keyword">if</span> (builtInKeyName &amp;&amp; eventKeyName &amp;&amp; !config.<span class="property">keyCodes</span>[key]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">isKeyNotMatch</span>(builtInKeyName, eventKeyName)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappedKeyCode) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">isKeyNotMatch</span>(mappedKeyCode, eventKeyCode)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventKeyName) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hyphenate</span>(eventKeyName) !== key</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> eventKeyCode === <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> isKeyNotMatch&lt;T&gt;(<span class="attr">expect</span>: T | <span class="title class_">Array</span>&lt;T&gt;, <span class="attr">actual</span>: T): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(expect)) &#123;</span><br><span class="line">    <span class="keyword">return</span> expect.<span class="title function_">indexOf</span>(actual) === -<span class="number">1</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> expect !== actual</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hyphenate 将驼峰式命名的字符串转换为连字符分隔的小写字符串（kebab-case 格式）</span></span><br><span class="line"><span class="keyword">const</span> hyphenateRE = <span class="regexp">/\B([A-Z])/g</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> hyphenate = <span class="title function_">cached</span>((<span class="attr">str</span>: <span class="built_in">string</span>): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> str.<span class="title function_">replace</span>(hyphenateRE, <span class="string">&#x27;-$1&#x27;</span>).<span class="title function_">toLowerCase</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>

<h4 id="bindObjectProps"><a href="#bindObjectProps" class="headerlink" title="bindObjectProps"></a>bindObjectProps</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for merging v-bind=&quot;object&quot; into a VNode&#x27;s data.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">bindObjectProps</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">data</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">tag</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">asProp</span>: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">isSync</span>?: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">VNodeData</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">&#x27;v-bind without argument expects an Object or Array value&#x27;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">        value = <span class="title function_">toObject</span>(value)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> hash</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&#x27;class&#x27;</span> || key === <span class="string">&#x27;style&#x27;</span> || <span class="title function_">isReservedAttribute</span>(key)) &#123;</span><br><span class="line">          hash = data</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">type</span> = data.<span class="property">attrs</span> &amp;&amp; data.<span class="property">attrs</span>.<span class="property">type</span></span><br><span class="line">          hash =</span><br><span class="line">            asProp || config.<span class="title function_">mustUseProp</span>(tag, <span class="keyword">type</span>, key)</span><br><span class="line">              ? data.<span class="property">domProps</span> || (data.<span class="property">domProps</span> = &#123;&#125;)</span><br><span class="line">              : data.<span class="property">attrs</span> || (data.<span class="property">attrs</span> = &#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> camelizedKey = <span class="title function_">camelize</span>(key)</span><br><span class="line">        <span class="keyword">const</span> hyphenatedKey = <span class="title function_">hyphenate</span>(key)</span><br><span class="line">        <span class="keyword">if</span> (!(camelizedKey <span class="keyword">in</span> hash) &amp;&amp; !(hyphenatedKey <span class="keyword">in</span> hash)) &#123;</span><br><span class="line">          hash[key] = value[key]</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isSync) &#123;</span><br><span class="line">            <span class="keyword">const</span> on = data.<span class="property">on</span> || (data.<span class="property">on</span> = &#123;&#125;)</span><br><span class="line">            on[<span class="string">`update:<span class="subst">$&#123;key&#125;</span>`</span>] = <span class="keyword">function</span> (<span class="params">$event</span>) &#123;</span><br><span class="line">              value[key] = $event</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="createTextVNode"><a href="#createTextVNode" class="headerlink" title="createTextVNode"></a>createTextVNode</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createTextVNode</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">string</span> | <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">VNode</span>(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="title class_">String</span>(val))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="createEmptyVNode"><a href="#createEmptyVNode" class="headerlink" title="createEmptyVNode"></a>createEmptyVNode</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">createEmptyVNode</span> = (<span class="params"><span class="attr">text</span>: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> node = <span class="keyword">new</span> <span class="title class_">VNode</span>()</span><br><span class="line">  node.<span class="property">text</span> = text</span><br><span class="line">  node.<span class="property">isComment</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">return</span> node</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="resolveScopedSlots"><a href="#resolveScopedSlots" class="headerlink" title="resolveScopedSlots"></a>resolveScopedSlots</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveScopedSlots</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">fns</span>: <span class="title class_">ScopedSlotsData</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">res</span>?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="comment">// the following are added in 2.6</span></span></span><br><span class="line"><span class="params">  <span class="attr">hasDynamicKeys</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">contentHashKey</span>?: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>): &#123; <span class="attr">$stable</span>: <span class="built_in">boolean</span> &#125; &amp; &#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">Function</span> &#125; &#123;</span><br><span class="line">  res = res || &#123; <span class="attr">$stable</span>: !hasDynamicKeys &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; fns.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> slot = fns[i]</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray</span>(slot)) &#123;</span><br><span class="line">      <span class="title function_">resolveScopedSlots</span>(slot, res, hasDynamicKeys)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (slot) &#123;</span><br><span class="line">      <span class="comment">// marker for reverse proxying v-slot without scope on this.$slots</span></span><br><span class="line">      <span class="comment">// @ts-expect-error</span></span><br><span class="line">      <span class="keyword">if</span> (slot.<span class="property">proxy</span>) &#123;</span><br><span class="line">        <span class="comment">// @ts-expect-error</span></span><br><span class="line">        slot.<span class="property">fn</span>.<span class="property">proxy</span> = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      res[slot.<span class="property">key</span>] = slot.<span class="property">fn</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (contentHashKey) &#123;</span><br><span class="line">    ;(res <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">$key</span> = contentHashKey</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="bindObjectListeners"><a href="#bindObjectListeners" class="headerlink" title="bindObjectListeners"></a>bindObjectListeners</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">bindObjectListeners</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">any</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>): <span class="title class_">VNodeData</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPlainObject</span>(value)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp; <span class="title function_">warn</span>(<span class="string">&#x27;v-on without argument expects an Object value&#x27;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> on = (data.<span class="property">on</span> = data.<span class="property">on</span> ? <span class="title function_">extend</span>(&#123;&#125;, data.<span class="property">on</span>) : &#123;&#125;)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> value) &#123;</span><br><span class="line">        <span class="keyword">const</span> existing = on[key]</span><br><span class="line">        <span class="keyword">const</span> ours = value[key]</span><br><span class="line">        on[key] = existing ? [].<span class="title function_">concat</span>(existing, ours) : ours</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="bindDynamicKeys"><a href="#bindDynamicKeys" class="headerlink" title="bindDynamicKeys"></a>bindDynamicKeys</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">bindDynamicKeys</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">baseObj</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">values</span>: <span class="title class_">Array</span>&lt;<span class="built_in">any</span>&gt;</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; values.<span class="property">length</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = values[i]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">&#x27;string&#x27;</span> &amp;&amp; key) &#123;</span><br><span class="line">      baseObj[values[i]] = values[i + <span class="number">1</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__ &amp;&amp; key !== <span class="string">&#x27;&#x27;</span> &amp;&amp; key !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// null is a special value for explicitly removing a binding</span></span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Invalid value for dynamic directive argument (expected string or null): <span class="subst">$&#123;key&#125;</span>`</span>,</span><br><span class="line">        <span class="variable language_">this</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> baseObj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="prependModifier"><a href="#prependModifier" class="headerlink" title="prependModifier"></a>prependModifier</h4><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// helper to dynamically append modifier runtime markers to event names.</span></span><br><span class="line"><span class="comment">// ensure only append when value is already string, otherwise it will be cast</span></span><br><span class="line"><span class="comment">// to string and cause the type check to miss.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">prependModifier</span>(<span class="params"><span class="attr">value</span>: <span class="built_in">any</span>, <span class="attr">symbol</span>: <span class="built_in">string</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&#x27;string&#x27;</span> ? <span class="built_in">symbol</span> + value : value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="nextTick"><a href="#nextTick" class="headerlink" title="$nextTick"></a>$nextTick</h3><div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$nextTick</span> = <span class="keyword">function</span> (<span class="params"><span class="attr">fn</span>: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">nextTick</span>(fn, <span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span>(<span class="params"><span class="attr">cb</span>?: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span>, <span class="attr">ctx</span>?: <span class="built_in">object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">  <span class="comment">// 将回调包装后推入回调队列</span></span><br><span class="line">  callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, ctx, <span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      <span class="title function_">_resolve</span>(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">timerFunc</span>() <span class="comment">// 启动异步执行器</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果没有回调且支持Promise，返回Promise</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// flushCallbacks把pending设为false，然后复制当前的callbacks数组，清空原数组，然后依次执行复制的回调。这样可以确保在回调执行过程中新添加的回调会在下一次的nextTick中处理，避免无限循环。</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>) <span class="comment">// 创建callbacks回调函数副本</span></span><br><span class="line">  callbacks.<span class="property">length</span> = <span class="number">0</span> <span class="comment">// 清空原队列</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> timerFunc</span><br><span class="line"><span class="comment">// 优先使用Promise（微任务）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">    <span class="keyword">if</span> (isIOS) <span class="built_in">setTimeout</span>(noop)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line"><span class="comment">// 次选MutationObserver（微任务）</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">  !isIE &amp;&amp;</span><br><span class="line">  <span class="keyword">typeof</span> <span class="title class_">MutationObserver</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp;</span><br><span class="line">  (<span class="title function_">isNative</span>(<span class="title class_">MutationObserver</span>) ||</span><br><span class="line">    <span class="comment">// PhantomJS and iOS 7.x</span></span><br><span class="line">    <span class="title class_">MutationObserver</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MutationObserverConstructor]&#x27;</span>)</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> counter = <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(flushCallbacks)</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="title class_">String</span>(counter))</span><br><span class="line">  observer.<span class="title function_">observe</span>(textNode, &#123;</span><br><span class="line">    <span class="attr">characterData</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    counter = (counter + <span class="number">1</span>) % <span class="number">2</span></span><br><span class="line">    textNode.<span class="property">data</span> = <span class="title class_">String</span>(counter)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line"><span class="comment">// 再次使用setImmediate（宏任务）</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 最后降级到setTimeout（宏任务）</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>核心机制说明：</strong></p>
<ol>
<li><strong>回调队列管理：</strong><ul>
<li>所有<code>nextTick</code>回调会被收集到<code>callbacks</code>数组</li>
<li>使用<code>pending</code>标志保证单次事件循环只启动一次异步任务</li>
</ul>
</li>
<li><strong>异步执行策略（优先级从高到低）：</strong><ul>
<li><strong>微任务队列：</strong><ul>
<li><code>Promise.then</code>（现代浏览器）</li>
<li><code>MutationObserver</code>（兼容方案）</li>
</ul>
</li>
<li><strong>宏任务队列：</strong><ul>
<li><code>setImmediate</code>（IE优选）</li>
<li><code>setTimeout</code>（保底方案）</li>
</ul>
</li>
</ul>
</li>
<li><strong>错误处理：</strong><ul>
<li>使用<code>try/catch</code>包裹回调执行</li>
<li>调用统一错误处理函数<code>handleError</code></li>
</ul>
</li>
<li><strong>Promise支持：</strong><ul>
<li>当不传回调时返回Promise</li>
<li>通过<code>_resolve</code>控制Promise的resolve时机</li>
</ul>
</li>
</ol>
<h3 id="render"><a href="#render" class="headerlink" title="_render"></a>_render</h3><p><strong>currentInstance</strong></p>
<p><strong>定义</strong>: 指向当前<strong>正在执行生命周期钩子或选项方法</strong>的组件实例。<br><strong>作用</strong>:</p>
<ul>
<li>确定 <code>this</code> 的指向：在生命周期钩子（如 <code>created</code>、<code>mounted</code>）或选项方法（如 <code>methods</code>）中，<code>this</code> 的上下文就是 <code>currentInstance</code></li>
<li>依赖收集：在模板或 <code>render</code> 函数中访问响应式数据时，确保依赖被正确收集到当前组件的渲染 Watcher 中</li>
<li>Composition API 支持：在 Vue 3 的 <code>setup()</code> 函数中，<code>getCurrentInstance()</code> 返回的正是 <code>currentInstance</code></li>
</ul>
<p><strong>currentRenderingInstance</strong></p>
<p><strong>定义</strong>: 指向当前<strong>正在执行渲染函数生成 VNode</strong> 的组件实例。<br><strong>作用</strong>:</p>
<ul>
<li>确定插槽内容的归属：在渲染过程中处理插槽内容时，确保父组件和子组件的插槽作用域正确隔离</li>
<li>防止循环渲染：在嵌套渲染（如父子组件交替更新）时标记当前正在渲染的实例，避免无限递归</li>
<li>动态组件追踪：在函数式组件或高阶组件中保持正确的组件引用链</li>
</ul>
<div class="code-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">  <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// 当组件已挂载且存在父 VNode 时，重新规范化作用域插槽（$scopedSlots），保证子组件能获取最新的插槽内容。</span></span><br><span class="line">  <span class="comment">// normalizeScopedSlots: 将父组件的插槽内容与当前实例的插槽合并</span></span><br><span class="line">  <span class="comment">// syncSetupSlots: 同步 Composition API 的 setup 中使用的插槽代理（Vue 3 特性向下兼容）</span></span><br><span class="line">  <span class="keyword">if</span> (_parentVnode &amp;&amp; vm.<span class="property">_isMounted</span>) &#123;</span><br><span class="line">    vm.<span class="property">$scopedSlots</span> = <span class="title function_">normalizeScopedSlots</span>(</span><br><span class="line">      vm.<span class="property">$parent</span>!,</span><br><span class="line">      _parentVnode.<span class="property">data</span>!.<span class="property">scopedSlots</span>,</span><br><span class="line">      vm.<span class="property">$slots</span>,</span><br><span class="line">      vm.<span class="property">$scopedSlots</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">_slotsProxy</span>) &#123;</span><br><span class="line">      <span class="title function_">syncSetupSlots</span>(vm.<span class="property">_slotsProxy</span>, vm.<span class="property">$scopedSlots</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set parent vnode. this allows render functions to have access</span></span><br><span class="line">  <span class="comment">// to the data on the placeholder node.</span></span><br><span class="line">  vm.<span class="property">$vnode</span> = _parentVnode!  <span class="comment">// 标记当前组件在父VNode树中的位置</span></span><br><span class="line">  <span class="comment">// render self</span></span><br><span class="line">  <span class="keyword">const</span> prevInst = currentInstance <span class="comment">// currentInstance:向当前正在执行生命周期钩子或选项方法的组件实例</span></span><br><span class="line">  <span class="keyword">const</span> prevRenderInst = currentRenderingInstance <span class="comment">// currentRenderingInstance:向当前正在执行渲染函数生成 VNode 的组件实例。</span></span><br><span class="line">  <span class="keyword">let</span> vnode</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">setCurrentInstance</span>(vm)</span><br><span class="line">    currentRenderingInstance = vm</span><br><span class="line">    vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="title function_">handleError</span>(e, vm, <span class="string">`render`</span>) <span class="comment">// 统一错误处理（触发生命周期钩子 errorCaptured）</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; vm.<span class="property">$options</span>.<span class="property">renderError</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 如果有自定义方法renderError去渲染UI</span></span><br><span class="line">        vnode = vm.<span class="property">$options</span>.<span class="property">renderError</span>.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>, e)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, vm, <span class="string">`renderError`</span>)</span><br><span class="line">        vnode = vm.<span class="property">_vnode</span> <span class="comment">// 回退到旧的 VNode 防止白屏</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode = vm.<span class="property">_vnode</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentRenderingInstance = prevRenderInst</span><br><span class="line">    <span class="title function_">setCurrentInstance</span>(prevInst)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if the returned array contains only a single node, allow it</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isArray</span>(vnode) &amp;&amp; vnode.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    vnode = vnode[<span class="number">0</span>] <span class="comment">// 单根数组自动解包</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// return empty vnode in case the render function errored out</span></span><br><span class="line">  <span class="keyword">if</span> (!(vnode <span class="keyword">instanceof</span> <span class="title class_">VNode</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Multiple root nodes returned from render function. Render function &#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;should return a single root node.&#x27;</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    vnode = <span class="title function_">createEmptyVNode</span>()  <span class="comment">// 生成空占位 VNode</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// set parent</span></span><br><span class="line">  vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">currentInstance</th>
<th align="left">currentRenderingInstance</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>生命周期阶段</strong></td>
<td align="left">整个组件生命周期（创建、更新等）</td>
<td align="left">仅在执行 <code>render</code> 函数期间有效</td>
</tr>
<tr>
<td align="left"><strong>主要用途</strong></td>
<td align="left">确定选项方法中的 <code>this</code> 指向</td>
<td align="left">确定渲染过程中插槽&#x2F;子组件的上下文</td>
</tr>
<tr>
<td align="left"><strong>变更频率</strong></td>
<td align="left">频繁变化（每次实例方法调用）</td>
<td align="left">仅在渲染期间变化</td>
</tr>
<tr>
<td align="left"><strong>访问方式</strong></td>
<td align="left">可通过 <code>getCurrentInstance()</code> 获取</td>
<td align="left">Vue 内部使用，不直接暴露</td>
</tr>
</tbody></table>
<h2 id="关键设计思想总结-1"><a href="#关键设计思想总结-1" class="headerlink" title="关键设计思想总结"></a>关键设计思想总结</h2><ol>
<li><strong>模块化初始化</strong>：通过 <code>initLifecycle</code>、<code>initEvents</code> 等函数分离关注点，确保逻辑清晰。</li>
<li><strong>生命周期控制</strong>：在关键节点触发钩子（如 <code>beforeCreate</code> 和 <code>created</code>），让开发者介入初始化过程。</li>
<li><strong>响应式前置</strong>：在 <code>initState</code> 中完成数据劫持，确保后续操作能依赖响应式系统。</li>
<li><strong>性能优化</strong>：开发环境下的性能标记和代理检查，生产环境去除非必要逻辑。</li>
</ol>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Vue2源码学习 - Vue 实例初始化（核心入口）</li>
        <li><strong>Author:</strong> chengj-code</li>
        <li><strong>Created at
                :</strong> 2025-05-17 00:00:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-06-07 22:14:50
            </li>
        
        <li>
            <strong>Link:</strong> https://chengj-code.github.io/2025/05/17/Vue2源码学习/Vue2源码学习 - Vue 实例初始化（核心入口）/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-v2-7-16/">#源码解读, v2.7.16</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/05/24/Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%20-%20%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F%EF%BC%88%E6%95%B0%E6%8D%AE%E9%A9%B1%E5%8A%A8%E6%A0%B8%E5%BF%83%EF%BC%89/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">Vue2源码学习 - 响应式系统（数据驱动核心）</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/05/17/Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%20-%20%E6%80%BB%E7%BB%93/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">Vue2源码学习 - 总结</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Vue2源码学习 - Vue 实例初始化（核心入口）</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E9%A1%BA%E5%BA%8F"><span class="nav-number">1.</span> <span class="nav-text">Vue2源码解读顺序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Vue-%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%88%E6%A0%B8%E5%BF%83%E5%85%A5%E5%8F%A3%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">Vue 实例初始化（核心入口）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">2.1.</span> <span class="nav-text">构造函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#initMixin"><span class="nav-number">2.1.1.</span> <span class="nav-text">initMixin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#initInternalComponent"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">initInternalComponent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveConstructorOptions"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">resolveConstructorOptions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveModifiedOptions"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">resolveModifiedOptions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E6%80%BB%E7%BB%93"><span class="nav-number">2.1.1.4.</span> <span class="nav-text">关键设计思想总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initProxy"><span class="nav-number">2.1.2.</span> <span class="nav-text">initProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initLifecycle"><span class="nav-number">2.1.3.</span> <span class="nav-text">initLifecycle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initEvents"><span class="nav-number">2.1.4.</span> <span class="nav-text">initEvents</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initRender"><span class="nav-number">2.1.5.</span> <span class="nav-text">initRender</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#createElement"><span class="nav-number">2.1.5.1.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveSlots"><span class="nav-number">2.1.5.2.</span> <span class="nav-text">resolveSlots</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#normalizeScopedSlots"><span class="nav-number">2.1.5.3.</span> <span class="nav-text">normalizeScopedSlots</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initInjections"><span class="nav-number">2.1.6.</span> <span class="nav-text">initInjections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initState"><span class="nav-number">2.1.7.</span> <span class="nav-text">initState</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#initProps"><span class="nav-number">2.1.7.1.</span> <span class="nav-text">initProps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initSetup"><span class="nav-number">2.1.7.2.</span> <span class="nav-text">initSetup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initMethods"><span class="nav-number">2.1.7.3.</span> <span class="nav-text">initMethods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initData"><span class="nav-number">2.1.7.4.</span> <span class="nav-text">initData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initComputed"><span class="nav-number">2.1.7.5.</span> <span class="nav-text">initComputed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initWatch"><span class="nav-number">2.1.7.6.</span> <span class="nav-text">initWatch</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initProvide"><span class="nav-number">2.1.8.</span> <span class="nav-text">initProvide</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stateMixin"><span class="nav-number">2.2.</span> <span class="nav-text">stateMixin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#set"><span class="nav-number">2.2.1.</span> <span class="nav-text">$set</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#del"><span class="nav-number">2.2.2.</span> <span class="nav-text">$del</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#watch"><span class="nav-number">2.2.3.</span> <span class="nav-text">$watch</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eventsMixin"><span class="nav-number">2.3.</span> <span class="nav-text">eventsMixin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-off%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF%E5%80%92%E5%BA%8F%E9%81%8D%E5%8E%86"><span class="nav-number">2.3.1.</span> <span class="nav-text">为什么$off使用的是倒序遍历</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E7%B4%A2%E5%BC%95%E9%94%99%E4%BD%8D%E9%97%AE%E9%A2%98"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">避免索引错位问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">性能优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lifecycleMixin"><span class="nav-number">2.4.</span> <span class="nav-text">lifecycleMixin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#patch"><span class="nav-number">2.4.1.</span> <span class="nav-text">patch</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#renderMixin"><span class="nav-number">2.5.</span> <span class="nav-text">renderMixin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95"><span class="nav-number">2.5.1.</span> <span class="nav-text">工具方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#markOnce"><span class="nav-number">2.5.1.1.</span> <span class="nav-text">markOnce</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#toString-toNumber"><span class="nav-number">2.5.1.2.</span> <span class="nav-text">toString&#x2F;toNumber</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#renderList"><span class="nav-number">2.5.1.3.</span> <span class="nav-text">renderList</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#renderSlot"><span class="nav-number">2.5.1.4.</span> <span class="nav-text">renderSlot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#looseEqual"><span class="nav-number">2.5.1.5.</span> <span class="nav-text">looseEqual</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#looseIndexOf"><span class="nav-number">2.5.1.6.</span> <span class="nav-text">looseIndexOf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#renderStatic"><span class="nav-number">2.5.1.7.</span> <span class="nav-text">renderStatic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveFilter"><span class="nav-number">2.5.1.8.</span> <span class="nav-text">resolveFilter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#checkKeyCodes"><span class="nav-number">2.5.1.9.</span> <span class="nav-text">checkKeyCodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bindObjectProps"><span class="nav-number">2.5.1.10.</span> <span class="nav-text">bindObjectProps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createTextVNode"><span class="nav-number">2.5.1.11.</span> <span class="nav-text">createTextVNode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createEmptyVNode"><span class="nav-number">2.5.1.12.</span> <span class="nav-text">createEmptyVNode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveScopedSlots"><span class="nav-number">2.5.1.13.</span> <span class="nav-text">resolveScopedSlots</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bindObjectListeners"><span class="nav-number">2.5.1.14.</span> <span class="nav-text">bindObjectListeners</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bindDynamicKeys"><span class="nav-number">2.5.1.15.</span> <span class="nav-text">bindDynamicKeys</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prependModifier"><span class="nav-number">2.5.1.16.</span> <span class="nav-text">prependModifier</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nextTick"><span class="nav-number">2.5.2.</span> <span class="nav-text">$nextTick</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#render"><span class="nav-number">2.5.3.</span> <span class="nav-text">_render</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E6%80%BB%E7%BB%93-1"><span class="nav-number">2.6.</span> <span class="nav-text">关键设计思想总结</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">chengj-code</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        7 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>





    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>








    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





	
</body>

</html>